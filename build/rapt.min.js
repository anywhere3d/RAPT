'use strict';(function(a){var b,c=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var d=0;d<c.length;++d){var e=c[d];if(a.performance[e]){b=function(){return a.performance[e]()};break}}b||(b=Date.now);a.perfNow=b})(window);var THREE,playNext=playNext||null,RAPT=RAPT||{};RAPT.MESSAGE=null;RAPT.LEVELS="Intro 1;Intro 2;Intro 3;Intro 4;It's Okay, You Can Press Escape;Doomed;Mr. Four-Arms;Chain;Traps;Walk Through Walls;My Head 'Asplode;No Cover;Hunter Food;Run!;Shocker;Laserland;Up and Down;Leap Of Faith;Sandwiched;Clock Tower;Stick Together;Foursquare;Going Down Faster;Bomberland;Coordinated Panic;Going Down;Look But Don't Touch;Triple Threat;Better Keep Moving;Tour;Cube".split(";");
RAPT.gameScale=60;var GAME_WIN_TEXT="You won!  Hit SPACE to play the next level or ESC for the level selection menu.",GOLDEN_COG_TEXT="You earned a golden cog!",SILVER_COG_TEXT="You earned a silver cog!",GAME_LOSS_TEXT="You lost.  Hit SPACE to restart, or ESC to select a new level.",TEXT_BOX_X_MARGIN=6,TEXT_BOX_Y_MARGIN=6,SECONDS_BETWEEN_TICKS=1/60,useFixedPhysicsTick=!1;RAPT.gameState=null;
RAPT.Game=function(a){RAPT.MESSAGE=a;this.w=window.innerWidth;this.h=window.innerHeight;this.json=null;this.fixedPhysicsTick=this.fps=0;this.isDone=!1;this.onWin=null;this.then=this.delta=this.timeNow=0;this.timerStep=1E3/60;this.lastTime=0;this.pause=!1;RAPT.gameState=new RAPT.GameState};
RAPT.Game.prototype={constructor:RAPT.Game,resize:function(){this.w=window.innerWidth;this.h=window.innerHeight},makePause:function(){this.pause=!0},stopPause:function(){this.pause=!1;this.lastTime=window.perfNow()},tick:function(){if(!this.pause){var a=window.perfNow(),b=0.001*(a-this.lastTime);this.lastTime=a;if(useFixedPhysicsTick)for(a=0,this.fixedPhysicsTick+=b;3>=++a&&0<=this.fixedPhysicsTick;)this.fixedPhysicsTick-=SECONDS_BETWEEN_TICKS,RAPT.gameState.tick(SECONDS_BETWEEN_TICKS),RAPT.Particle.tick(SECONDS_BETWEEN_TICKS),
this.update3d();else RAPT.gameState.tick(b),RAPT.Particle.tick(b),this.update3d();if(!this.isDone&&RAPT.gameState.gameStatus!=RAPT.GAME_IN_PLAY&&(this.isDone=!0,RAPT.gameState.gameStatus==RAPT.GAME_WON&&this.onWin))this.onWin()}},message:function(a){RAPT.MESSAGE.innerHTML=a},update3d:function(){var a=RAPT.gameState.playerA.getCenter(),b=RAPT.gameState.playerB.getCenter(),c=this.w/RAPT.gameScale,d=this.h/RAPT.gameScale,e=a.add(b).div(2),f=b.sub(a).unit(),f=new RAPT.Vector(c/Math.abs(f.x),d/Math.abs(f.y)),
c=0.25*Math.min(f.x,f.y),d=b.sub(a).lengthSquared()>4*c*c;RAPT.W3D.setSplit(d);d?(d=b.sub(a).unit().mul(99).flip(),f=e.sub(a),f.lengthSquared()>c*c&&(f=f.unit().mul(c)),f=f.add(a),e=e.sub(b),e.lengthSquared()>c*c&&(e=e.unit().mul(c)),e=e.add(b),RAPT.W3D.upCamera(f.x,f.y,1),RAPT.W3D.upCamera(e.x,e.y,2),a=Math.min(0.1,0.01*(b.sub(a).length()-1.9*c)),b=Math.atan2(d.y+d.y,d.x+d.x)-0.5*Math.PI,RAPT.W3D.effect.setAngle(-b),RAPT.W3D.effect.setFuzzy(a)):RAPT.W3D.upCamera(e.x,e.y,0);RAPT.gameState.gameStatus===
RAPT.GAME_WON?this.message((this.lastLevel?"Congratulations, you beat the last level in this set!\tPress SPACE or ESC to return to the level selection menu.":GAME_WIN_TEXT)+("<br>Cogs Collected: "+RAPT.gameState.stats[RAPT.STAT_COGS_COLLECTED]+"/"+RAPT.gameState.stats[RAPT.STAT_NUM_COGS])):RAPT.gameState.gameStatus===RAPT.GAME_LOST&&this.message(GAME_LOSS_TEXT)},load:function(a){var b=new XMLHttpRequest,c=this;b.onreadystatechange=function(){4==b.readyState&&(c.json=JSON.parse(this.responseText),
c.restart())};b.open("get","level/"+a+".json",!0);b.send()},restart:function(){RAPT.gameState.loadLevelFromJSON(this.json)},keyDown:function(a){var b=a.which,c=RAPT.Keys.fromKeyCode(b);null!=c&&(0==c.indexOf("a-")?RAPT.gameState.playerA[c.substr(2)]=!0:0==c.indexOf("b-")?RAPT.gameState.playerB[c.substr(2)]=!0:RAPT.gameState[c]=!0,a.preventDefault(),a.stopPropagation());32===b&&(RAPT.gameState.gameStatus===RAPT.GAME_WON?playNext():this.restart())},keyUp:function(a){var b=RAPT.Keys.fromKeyCode(a.which);
null!=b&&(0==b.indexOf("a-")?RAPT.gameState.playerA[b.substr(2)]=!1:0==b.indexOf("b-")?RAPT.gameState.playerB[b.substr(2)]=!1:RAPT.gameState[b]=!1,a.preventDefault(),a.stopPropagation())}};
RAPT.Keys={keyMap:{killKey:75,"a-jumpKey":38,"a-crouchKey":40,"a-leftKey":37,"a-rightKey":39,"b-jumpKey":87,"b-jumpKey2":90,"b-crouchKey":83,"b-leftKey":65,"b-leftKey2":81,"b-rightKey":68},fromKeyCode:function(a){for(var b in this.keyMap)if(a==this.keyMap[b])return"b-jumpKey2"==b&&(b="b-jumpKey"),"b-leftKey2"==b&&(b="b-leftKey"),b;return null}};RAPT.random=Math.random;RAPT.lerp=function(a,b,c){return a+(b-a)*c};RAPT.randInRange=function(a,b){return RAPT.lerp(a,b,RAPT.random())};RAPT.randInt=function(a,b,c){return 1*RAPT.lerp(a,b,RAPT.random()).toFixed(c||0)};RAPT.PI=3.141592653589793;RAPT.PI90=1.570796326794896;RAPT.PI270=4.712388980384689;RAPT.TwoPI=6.283185307179586;RAPT.ToRad=0.017453292519943295;RAPT.ToDeg=57.29577951308232;
RAPT.adjustAngleToTarget=function(a,b,c){b-a>RAPT.PI?a+=RAPT.TwoPI:a-b>RAPT.PI&&(a-=RAPT.TwoPI);b-=a;Math.abs(b)>c&&(b=0<b?c:-c);a+=b;return a-=Math.floor(a/RAPT.TwoPI)*RAPT.TwoPI};RAPT.Vector=function(a,b){this.x=a||0;this.y=b||0};
RAPT.Vector.prototype={constructor:RAPT.Vector,neg:function(){return new RAPT.Vector(-this.x,-this.y)},add:function(a){return new RAPT.Vector(this.x+a.x,this.y+a.y)},sub:function(a){return new RAPT.Vector(this.x-a.x,this.y-a.y)},mul:function(a){return new RAPT.Vector(this.x*a,this.y*a)},div:function(a){return new RAPT.Vector(this.x/a,this.y/a)},eq:function(a){return 0.001>Math.abs(this.x-a.x)+Math.abs(this.y-a.y)},inplaceNeg:function(){this.x=-this.x;this.y=-this.y},inplaceAdd:function(a){this.x+=
a.x;this.y+=a.y},inplaceSub:function(a){this.x-=a.x;this.y-=a.y},inplaceMul:function(a){this.x*=a;this.y*=a},inplaceDiv:function(a){this.x/=a;this.y/=a},inplaceFlip:function(){var a=this.x;this.x=this.y;this.y=-a},clone:function(){return new RAPT.Vector(this.x,this.y)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.div(this.length())},normalize:function(){var a=this.length();
this.x/=a;this.y/=a},flip:function(){return new RAPT.Vector(this.y,-this.x)},atan2:function(){return Math.atan2(this.y,this.x)},angleBetween:function(a){return this.atan2()-a.atan2()},rotate:function(a){var b=Math.sin(a);a=Math.cos(a);return new RAPT.Vector(this.x*a-this.y*b,this.x*b+this.y*a)},minComponents:function(a){return new RAPT.Vector(Math.min(this.x,a.x),Math.min(this.y,a.y))},maxComponents:function(a){return new RAPT.Vector(Math.max(this.x,a.x),Math.max(this.y,a.y))},projectOntoAUnitVector:function(a){return a.mul(this.dot(a))},
toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"},adjustTowardsTarget:function(a,b){var c=a.sub(this).lengthSquared()<b*b?a:this.add(a.sub(this).unit().mul(b));this.x=c.x;this.y=c.y},fromAngle:function(a){return new RAPT.Vector(Math.cos(a),Math.sin(a))},lerp:function(a,b,c){return a.add(b.sub(a).mul(c))}};RAPT.SHAPE_CIRCLE=0;RAPT.SHAPE_AABB=1;RAPT.SHAPE_POLYGON=2;RAPT.MAX_VELOCITY=30;RAPT.MAX_COLLISIONS=20;RAPT.MAX_EMERGENCY_ELASTICITY=0.5;RAPT.ON_MARGIN=0.01;RAPT.MAX_LOS_DISTANCE_SQUARED=625;RAPT.EMERGENCY_PUSH_DISTANCE=0.1;RAPT.Contact=function(a,b,c){this.proportionOfDelta=c;this.contactPoint=a;this.normal=b};RAPT.CollisionDetector=function(){};
RAPT.CollisionDetector.prototype={constructor:RAPT.CollisionDetector,collideEntityWorld:function(a,b,c,d,e,f){return this.collideShapeWorld(a.getShape(),b,c,d,e,a.getColor(),f)},collideShapeWorld:function(a,b,c,d,e,f,g){if(1E-12>b.ref.lengthSquared())return b.ref=new RAPT.Vector(0,0),null;c.ref.lengthSquared()>RAPT.MAX_VELOCITY*RAPT.MAX_VELOCITY&&(c.ref=c.ref.unit().mul(RAPT.MAX_VELOCITY));for(var h=null,k=b.ref,l=c.ref,m=RAPT.MAX_COLLISIONS;m--;){var n=a.copy();n.moveBy(b.ref);for(var n=a.getAabb().union(n.getAabb()),
p=e.getEdgesInAabb(n,f),n=null,q=p.length;q--;){var r=this.collideShapeSegment(a,b.ref,p[q].segment);if(null===n||null!==r&&r.proportionOfDelta<n.proportionOfDelta)n=r}if(null===n)return this.emergencyCollideShapeWorld(a,b,c,e),h;h=c.ref.projectOntoAUnitVector(n.normal);p=c.ref.sub(h);c.ref=p.add(h.mul(-d));h=b.ref.projectOntoAUnitVector(n.normal);p=b.ref.sub(h);q=1-n.proportionOfDelta;b.ref=b.ref.mul(n.proportionOfDelta).add(h.mul(-d*q)).add(p.mul(q)).add(n.normal.mul(1E-4));h=n}"undefined"!==typeof console&&
console.log&&console.log("Collision loop ran out, damn!");b.ref=new RAPT.Vector(0,0);c.ref=l.mul(-(d<RAPT.MAX_EMERGENCY_ELASTICITY?d:RAPT.MAX_EMERGENCY_ELASTICITY));g&&this.emergencyCollideShapeWorld(a,{ref:k},c,e);return h},overlapShapePlayers:function(a){var b=[];this.overlapShapes(RAPT.gameState.playerA.getShape(),a)&&b.push(RAPT.gameState.playerA);this.overlapShapes(RAPT.gameState.playerB.getShape(),a)&&b.push(RAPT.gameState.playerB);return b},overlapPlayers:function(){return this.overlapShapes(RAPT.gameState.playerA.getShape(),
RAPT.gameState.playerB.getShape())},onEntityWorld:function(a,b,c){this.penetrationEntityWorld(a,b,c);b.throwOutIfGreaterThan(RAPT.ON_MARGIN)},lineOfSightWorld:function(a,b,c){if(b.sub(a).lengthSquared()>RAPT.MAX_LOS_DISTANCE_SQUARED)return null;c=c.getEdgesInAabb(new RAPT.AABB(a,b),RAPT.EDGE_ENEMIES);for(var d=1.1,e={},f={},g=null,h=c.length;h--;)if(!(0<=b.sub(a).dot(c[h].segment.normal))){var k={};!this.intersectSegments(new RAPT.Segment(a,b),c[h].segment,k,e,f)||k.ref>=d||(d=k.ref,g=c[h])}return g},
closestToEntityWorld:function(a,b,c,d,e){var f=a.getShape();b=f.getAabb().expand(b);a=e.getEdgesInAabb(b,a.getColor());e=Number.POSITIVE_INFINITY;for(b=a.length;b--;){var g={},h={},k=this.closestToShapeSegment(f,g,h,a[b].segment);k<e&&(e=k,c.ref=g.ref,d.ref=h.ref)}return e},containsPointShape:function(a,b){switch(b.getType()){case RAPT.SHAPE_CIRCLE:return a.sub(b.center).lengthSquared()<b.radius*b.radius;case RAPT.SHAPE_AABB:return a.x>=b.lowerLeft.x&&a.x<=b.lowerLeft.x+b.size.x&&a.y>=b.lowerLeft.y&&
a.y<=b.lowerLeft.y+b.size.y;case RAPT.SHAPE_POLYGON:for(var c=b.vertices.length;c--;)if(0<a.sub(b.vertices[c].add(b.center)).dot(b.segments[c].normal))return!1;return!0}alert("assertion failed in CollisionDetector.containsPointShape")},intersectEntitySegment:function(a,b){return this.intersectShapeSegment(a.getShape(),b)},intersectSegments:function(a,b,c,d,e){var f=a.start;a=a.end.sub(f);var g=b.start;b=b.end.sub(g);if(1E-6>Math.abs(a.dot(b.flip())))return!1;c.ref=((g.y-f.y)*b.x+(f.x-g.x)*b.y)/(a.y*
b.x-b.y*a.x);d.ref=((f.y-g.y)*a.x+(g.x-f.x)*a.y)/(b.y*a.x-a.y*b.x);e.ref=f.add(a.mul(c.ref));return 0>c.ref||1<c.ref||0>d.ref||1<d.ref?!1:!0},intersectCircleLine:function(a,b,c,d){var e=b.start,f=b.end.sub(e);b=f.lengthSquared();f=2*f.dot(e.sub(a.center));a=e.sub(a.center).lengthSquared()-a.radius*a.radius;a=f*f-4*b*a;if(0>a)return!1;b=1/b;c.ref=0.5*(-f-Math.sqrt(a))*b;d.ref=0.5*(-f+Math.sqrt(a))*b;return!0},intersectShapeSegment:function(a,b){switch(a.getType()){case RAPT.SHAPE_CIRCLE:return this.intersectCircleSegment(a,
b);case RAPT.SHAPE_AABB:return this.intersectPolygonSegment(a.getPolygon(),b);case RAPT.SHAPE_POLYGON:return this.intersectPolygonSegment(a,b)}alert("assertion failed in CollisionDetector.intersectShapeSegment")},intersectCircleSegment:function(a,b){var c={},d={};return this.intersectCircleLine(a,b,c,d)?0<=c.ref&&1>=c.ref?!0:0<=d.ref&&1>=d.ref:!1},intersectPolygonSegment:function(a,b){for(var c={},d={},e={},f=a.vertices.length;f--;)if(this.intersectSegments(a.getSegment(f),b,c,d,e))return!0;return!1},
collideShapeSegment:function(a,b,c){if(0<b.dot(c.normal))return null;switch(a.getType()){case RAPT.SHAPE_CIRCLE:return this.collideCircleSegment(a,b,c);case RAPT.SHAPE_AABB:return this.collidePolygonSegment(a.getPolygon(),b,c);case RAPT.SHAPE_POLYGON:return this.collidePolygonSegment(a,b,c)}alert("assertion failed in CollisionDetector.collideShapeSegment")},collideCircleSegment:function(a,b,c){var d=c.normal,e=d.mul(-a.radius),e=(new RAPT.Circle(a.center.add(b),a.radius)).center.add(e);if(!(0.001>
e.sub(c.start).dot(d)))return null;var f=e.sub(b);if(0<f.sub(c.start).dot(d)){var g={},h={};if(this.intersectSegments(c,new RAPT.Segment(f,e),{},g,h))return new RAPT.Contact(h.ref,d,g.ref)}d=this.collideCirclePoint(a,b,c.start);a=this.collideCirclePoint(a,b,c.end);return d||a?d&&!a?d:!d&&a?a:d.proportionOfDelta<a.proportionOfDelta?d:a:null},collideCirclePoint:function(a,b,c){var d={};if(1E-7>b.length())return!1;if(!this.intersectCircleLine(a,new RAPT.Segment(c,c.sub(b)),d,{})||0>d.ref||1<d.ref)return null;
a=a.center.add(b.mul(d.ref));return new RAPT.Contact(c,a.sub(c).unit(),d.ref)},collidePolygonSegment:function(a,b,c){var d={},e={},f={};if(this.intersectPolygonSegment(a,c))return null;var g=null,h;for(h=a.vertices.length;h--;)for(var k=[c.start,c.end],l=c.start.add(c.end).div(2),m=2;m--;){var n=a.getSegment(h);0<n.normal.dot(k[m].sub(l))||!this.intersectSegments(n,new RAPT.Segment(k[m],k[m].sub(b)),d,e,f)||g&&!(e.ref<g.proportionOfDelta)||(g=new RAPT.Contact(f.ref,n.normal.mul(-1),e.ref))}for(h=
a.vertices.length;h--;)k=a.getVertex(h),this.intersectSegments(c,new RAPT.Segment(k,k.add(b)),d,e,f)&&(!g||e.ref<g.proportionOfDelta)&&(g=new RAPT.Contact(f.ref,c.normal,e.ref));return g},emergencyCollideShapeWorld:function(a,b,c,d){var e=!1;c=a.copy();c.moveBy(b.ref);0>c.getAabb().getBottom()&&(e=!0);c.getAabb().getTop()>d.height&&(e=!0);0>c.getAabb().getLeft()&&(e=!0);c.getAabb().getRight()>d.width&&(e=!0);if(!e)for(var f=d.getCellsInAabb(c.getAabb()),g=f.length;g--;){var h=f[g].getShape();if(h&&
this.overlapShapes(c,h)){e=!0;break}}if(e){for(var k=Math.floor(c.getCenter().x)-3,e=Math.floor(c.getCenter().x)+3,f=Math.floor(c.getCenter().y)-3,g=Math.floor(c.getCenter().y)+3,h=d.safety;k<=e;k++)for(var l=f;l<=g;l++)if(d.getCell(k,l)&&d.getCell(k,l).type==RAPT.CELL_EMPTY){var m=new RAPT.Vector(k+0.5,l+0.5);m.sub(c.getCenter()).lengthSquared()<h.sub(c.getCenter()).lengthSquared()&&(h=m)}c.moveBy(h.sub(c.getCenter()).unit().mul(RAPT.EMERGENCY_PUSH_DISTANCE));b.ref=c.getCenter().sub(a.getCenter())}},
overlapShapes:function(a,b){var c=null,d=a.copy(),e=b.copy();d.getType()==RAPT.SHAPE_AABB&&(d=d.getPolygon());e.getType()==RAPT.SHAPE_AABB&&(e=e.getPolygon());d.getType()>e.getType()&&(c=e,e=d,d=c);var f,c=d.getType(),g=e.getType();c==RAPT.SHAPE_CIRCLE&&g==RAPT.SHAPE_CIRCLE?f=this.overlapCircles(d,e):c==RAPT.SHAPE_CIRCLE&&g==RAPT.SHAPE_POLYGON?f=this.overlapCirclePolygon(d,e):c==RAPT.SHAPE_POLYGON&&g==RAPT.SHAPE_POLYGON?f=this.overlapPolygons(d,e):alert("assertion failed in CollisionDetector.overlapShapes");
return f},overlapCircles:function(a,b){return b.getCenter().sub(a.getCenter()).lengthSquared()<=(a.radius+b.radius)*(a.radius+b.radius)},overlapCirclePolygon:function(a,b){for(var c=b.vertices.length,d=c;d--;)if(this.intersectCircleSegment(a,b.getSegment(d))||b.getVertex(d).sub(a.center).lengthSquared()<a.radius*a.radius)return!0;for(var e=a.center,d=c;d--;)if(0<e.sub(b.vertices[d].add(b.center)).dot(b.segments[d].normal))return!1;return!0},overlapPolygons:function(a,b){var c;for(c=a.vertices.length;c--;)if(this.containsPointPolygon(a.vertices[c].add(a.center),
b))return!0;for(c=b.vertices.length;c--;)if(this.containsPointPolygon(b.vertices[c].add(b.center),a))return!0;return!1},containsPointPolygon:function(a,b){for(var c=b.vertices.length;c--;)if(0<a.sub(b.vertices[c].add(b.center)).dot(b.segments[c].normal))return!1;return!0},distanceShapeSegment:function(a,b){return this.intersectShapeSegment(a,b)?0:this.closestToShapeSegment(a,{},{},b)},distanceShapePoint:function(a,b){switch(a.getType()){case RAPT.SHAPE_CIRCLE:return this.distanceCirclePoint(a,b);
case RAPT.SHAPE_AABB:return this.distancePolygonPoint(a.getPolygon(),b);case RAPT.SHAPE_POLYGON:return this.distancePolygonPoint(a,b)}alert("assertion failed in CollisionDetector.distanceShapePoint")},distanceCirclePoint:function(a,b){var c=a.center.sub(b).length();return c>a.radius?c-a.radius:0},distancePolygonPoint:function(a,b){for(var c={},d={},e={},f=Number.POSITIVE_INFINITY,g=a.vertices.length;g--;){var h=a.getSegment(g);this.intersectSegments(h,new RAPT.Segment(b,b.add(h.normal)),c,d,e);0>
c.ref||1<c.ref||(h=Math.abs(d.ref),h<f&&(f=h))}return f},closestToShapeSegment:function(a,b,c,d){switch(a.getType()){case RAPT.SHAPE_CIRCLE:return this.closestToCircleSegment(a,b,c,d);case RAPT.SHAPE_AABB:return this.closestToPolygonSegment(a.getPolygon(),b,c,d);case RAPT.SHAPE_POLYGON:return this.closestToPolygonSegment(a,b,c,d)}alert("assertion failed in CollisionDetector.closestToShapeSegment")},closestToCircleSegment:function(a,b,c,d){var e={},f={};this.intersectSegments(d,new RAPT.Segment(a.center,
a.center.sub(d.normal)),e,f,c);if(0<=e.ref&&1>=e.ref)return b.ref=a.center.sub(d.normal.mul(a.radius*(0<f.ref?1:-1))),c.ref.sub(a.center).length()-a.radius;e=a.center.sub(d.start).lengthSquared();f=a.center.sub(d.end).lengthSquared();if(e<f)return c.ref=d.start,b.ref=a.center.add(c.ref.sub(a.center).unit().mul(a.radius)),Math.sqrt(e)-a.radius;c.ref=d.end;b.ref=a.center.add(c.ref.sub(a.center).unit().mul(a.radius));return Math.sqrt(f)-a.radius},closestToPolygonSegment:function(a,b,c,d){for(var e=Number.POSITIVE_INFINITY,
f,g=a.vertices.length;g--;)for(var h=a.getVertex(g),k=2;k--;){var l=0==k?d.start:d.end;f=h.sub(l).length();f<e&&(e=f,c.ref=l,b.ref=h)}for(var k={},l={},m={},g=a.vertices.length;g--;)h=a.getVertex(g),this.intersectSegments(d,new RAPT.Segment(h,h.sub(d.normal)),k,l,m),0>k.ref||1<k.ref||(f=Math.abs(l.ref),f<e&&(e=f,c.ref=m.ref,b.ref=h));for(var h={},n={},g=a.vertices.length;g--;)for(var p=a.getSegment(g),k=2;k--;)l=0==k?d.start:d.end,this.intersectSegments(p,new RAPT.Segment(l,l.add(p.normal)),h,n,m),
0>h.ref||1<h.ref||(f=Math.abs(n.ref),f<e&&(e=f,c.ref=l,b.ref=m.ref));return e},penetrationEntityWorld:function(a,b,c){var d=a.getShape();b.nullifyEdges();a=c.getEdgesInAabb(d.getAabb().expand(0.1),a.getColor());for(c=a.length;c--;)if(!(0.01<this.distanceShapeSegment(d,a[c].segment))){var e=this.penetrationShapeSegment(d,a[c].segment);0>e||b.minimize(a[c],e)}},penetrationShapeSegment:function(a,b){switch(a.getType()){case RAPT.SHAPE_CIRCLE:return this.penetrationCircleSegment(a,b);case RAPT.SHAPE_AABB:return this.penetrationPolygonSegment(a.getPolygon(),
b);case RAPT.SHAPE_POLYGON:return this.penetrationPolygonSegment(a,b)}alert("assertion failed in CollisionDetector.penetrationShapeSegment")},penetrationCircleSegment:function(a,b){var c=b.normal.mul(-a.radius);return a.center.add(c).sub(b.start).dot(b.normal)},penetrationPolygonSegment:function(a,b){for(var c=Number.POSITIVE_INFINITY,d={},e={},f={},g=a.vertices.length;g--;){var h=a.getVertex(g);this.intersectSegments(b,new RAPT.Segment(h,h.sub(b.normal)),d,e,f);!(0>d.ref||1<d.ref)&&e.ref<c&&(c=e.ref)}return c}};
RAPT.makeAABB=function(a,b,c){var d=new RAPT.Vector(0,0);a&&(d=new RAPT.Vector(a.x,a.y));b=new RAPT.Vector(0.5*b,0.5*c);a=d.sub(b);d=d.add(b);return new RAPT.AABB(a,d)};RAPT.AABB=function(a,b){this.lowerLeft=new RAPT.Vector(Math.min(a.x,b.x),Math.min(a.y,b.y));this.size=(new RAPT.Vector(Math.max(a.x,b.x),Math.max(a.y,b.y))).sub(this.lowerLeft)};
RAPT.AABB.prototype={constructor:RAPT.AABB,getTop:function(){return this.lowerLeft.y+this.size.y},getLeft:function(){return this.lowerLeft.x},getRight:function(){return this.lowerLeft.x+this.size.x},getBottom:function(){return this.lowerLeft.y},getWidth:function(){return this.size.x},getHeight:function(){return this.size.y},copy:function(){return new RAPT.AABB(this.lowerLeft,this.lowerLeft.add(this.size))},getPolygon:function(){var a=this.getCenter(),b=this.size.div(2);return new RAPT.Polygon(a,new RAPT.Vector(+b.x,
+b.y),new RAPT.Vector(-b.x,+b.y),new RAPT.Vector(-b.x,-b.y),new RAPT.Vector(+b.x,-b.y))},getType:function(){return RAPT.SHAPE_AABB},getAabb:function(){return this},moveBy:function(a){this.lowerLeft=this.lowerLeft.add(a)},moveTo:function(a){this.lowerLeft=a.sub(this.size.div(2))},getCenter:function(){return this.lowerLeft.add(this.size.div(2))},expand:function(a){a=new RAPT.Vector(a,a);return new RAPT.AABB(this.lowerLeft.sub(a),this.lowerLeft.add(this.size).add(a))},union:function(a){return new RAPT.AABB(this.lowerLeft.minComponents(a.lowerLeft),
this.lowerLeft.add(this.size).maxComponents(a.lowerLeft.add(a.size)))},include:function(a){return new RAPT.AABB(this.lowerLeft.minComponents(a),this.lowerLeft.add(this.size).maxComponents(a))},offsetBy:function(a){return new RAPT.AABB(this.lowerLeft.add(a),this.lowerLeft.add(this.size).add(a))},draw:function(a){a.strokeStyle="black";a.strokeRect(this.lowerLeft.x,this.lowerLeft.y,this.size.x,this.size.y)}};RAPT.EdgeQuad=function(){this.nullifyEdges();this.quantities=[0,0,0,0]};
RAPT.EdgeQuad.prototype={constructor:RAPT.EdgeQuad,nullifyEdges:function(){this.edges=[null,null,null,null]},minimize:function(a,b){var c=a.getOrientation();if(null==this.edges[c]||b<this.quantities[c])this.edges[c]=a,this.quantities[c]=b},throwOutIfGreaterThan:function(a){for(var b=0;4>b;b++)this.quantities[b]>a&&(this.edges[b]=null)}};RAPT.Segment=function(a,b){this.start=a;this.end=b;this.normal=b.sub(a).flip().unit()};
RAPT.Segment.prototype={constructor:RAPT.Segment,offsetBy:function(a){return new RAPT.Segment(this.start.add(a),this.end.add(a))}};RAPT.Polygon=function(a,b){var c=Array.prototype.slice.call(arguments);this.center=c.shift();this.vertices=c;this.segments=[];for(c=0;c<this.vertices.length;c++)this.segments.push(new RAPT.Segment(this.vertices[c],this.vertices[(c+1)%this.vertices.length]));this.boundingBox=new RAPT.AABB(this.vertices[0],this.vertices[0]);this.initializeBounds()};
RAPT.Polygon.prototype={constructor:RAPT.Polygon,copy:function(){var a=new RAPT.Polygon(this.center,this.vertices[0]);a.vertices=this.vertices;a.segments=this.segments;a.initializeBounds();return a},getType:function(){return RAPT.SHAPE_POLYGON},moveBy:function(a){this.center=this.center.add(a)},moveTo:function(a){this.center=a},getVertex:function(a){return this.vertices[a].add(this.center)},getSegment:function(a){return this.segments[a].offsetBy(this.center)},getAabb:function(){return this.boundingBox.offsetBy(this.center)},
getCenter:function(){return this.center},initializeBounds:function(){for(var a=0;a<this.vertices.length;a++)this.boundingBox=this.boundingBox.include(this.vertices[a])}};RAPT.Circle=function(a,b){this.center=a||new RAPT.Vector(0,0);this.radius=b};
RAPT.Circle.prototype={constructor:RAPT.Circle,copy:function(){return new RAPT.Circle(this.center,this.radius)},getType:function(){return RAPT.SHAPE_CIRCLE},getAabb:function(){var a=new RAPT.Vector(this.radius,this.radius);return new RAPT.AABB(this.center.sub(a),this.center.add(a))},getCenter:function(){return this.center},moveBy:function(a){this.center=this.center.add(a)},moveTo:function(a){this.center=a},offsetBy:function(a){return new RAPT.Circle(this.center.add(a),this.radius)}};RAPT.PARTICLE_CIRCLE=0;RAPT.PARTICLE_TRIANGLE=1;RAPT.PARTICLE_LINE=2;RAPT.PARTICLE_CUSTOM=3;RAPT.ParticleInstance=function(){};
RAPT.ParticleInstance.prototype={constructor:RAPT.ParticleInstance,init:function(){this.m_bounces=0;this.m_color=new THREE.Vector4;this.m_radius=this.m_type=0;this.m_gravity=new THREE.Vector3;this.m_elasticity=0;this.m_expand=this.m_decay=1;this.m_uvpos=new THREE.Vector2;this.m_pos=new THREE.Vector3;this.m_velocity=new THREE.Vector3;this.m_angularVelocity=this.m_angle=0;this.m_drawFunc=null;this.ntiles=8;this.m_animuv=!1},tick:function(a){if(0>this.m_bounces)return!1;this.m_animuv&&(this.m_uvpos.x++,
this.m_uvpos.x>this.ntiles&&(this.m_uvpos.x=0,this.m_uvpos.y++,this.m_uvpos.y>this.ntiles&&(this.m_uvpos.y=0)));this.m_color.w*=Math.pow(this.m_decay,a);this.m_radius*=Math.pow(this.m_expand,a);0!==this.m_gravity.x&&(this.m_velocity.x-=this.m_gravity.x*a);0!==this.m_gravity.y&&(this.m_velocity.y-=this.m_gravity.y*a);0!==this.m_gravity.z&&(this.m_velocity.z-=this.m_gravity.z*a);this.m_pos.x+=this.m_velocity.x*a;this.m_pos.y+=this.m_velocity.y*a;this.m_pos.z+=this.m_velocity.z*a;this.m_angle+=this.m_angularVelocity*
a;0.05>this.m_color.w&&(this.m_bounces=-1);return 0<=this.m_bounces},randOrTakeFirst:function(a,b){return"undefined"!==typeof b?RAPT.randInRange(a,b):a},cssRGBA:function(a,b,c,d){return"rgba("+Math.round(255*a)+", "+Math.round(255*b)+", "+Math.round(255*c)+", "+d+")"},fixangle:function(){var a=this.m_pos,b=this.m_pos.clone().add(this.m_velocity.clone().multiplyScalar(10));this.m_angle=-(Math.atan2(b.y-a.y,b.x-a.x)+Math.PI);return this},bounces:function(a,b){this.m_bounces=Math.round(this.randOrTakeFirst(a,
b));return this},type:function(a){var b=0,c=0;switch(a){case "circle":b=0;c=1;break;case "triangle":b=2;c=1;break;case "line":b=4;c=1;break;case "custom":b=6,c=1}this.m_uvpos.set(b,c);return this},setuv:function(a,b){this.m_uvpos.set(a,b);return this},animuv:function(){this.m_animuv=!0;return this},circle:function(){this.m_type=RAPT.PARTICLE_CIRCLE;return this},triangle:function(){this.m_type=RAPT.PARTICLE_TRIANGLE;return this},line:function(){this.m_type=RAPT.PARTICLE_LINE;return this},custom:function(a){this.m_type=
RAPT.PARTICLE_CUSTOM;this.m_drawFunc=a;return this},customSprite:function(a){return this},color:function(a,b,c,d){this.m_color.set(a||0,b||0,c||0,d||0);return this},mixColor:function(a,b,c,d){var e=Math.random();this.m_color.lerp(new THREE.Vector4(a,b,c,d),e);return this},radius:function(a,b){this.m_radius=this.randOrTakeFirst(a,b);return this},gravity:function(a,b,c){this.m_gravity[c||"y"]=this.randOrTakeFirst(a,b);return this},elasticity:function(a,b){this.m_elasticity=this.randOrTakeFirst(a,b);
return this},decay:function(a,b){this.m_decay=this.randOrTakeFirst(a,b);return this},expand:function(a,b){this.m_expand=this.randOrTakeFirst(a,b);return this},angle:function(a,b){this.m_angle=this.randOrTakeFirst(a,b);return this},angularVelocity:function(a,b){this.m_angularVelocity=this.randOrTakeFirst(a,b);return this},position:function(a){this.m_pos.set(a.x||0,a.y||0,a.z||0);return this},velocity:function(a){this.m_velocity.set(a.x||0,a.y||0,a.z||0);return this}};
RAPT.Particle=function(){for(var a=null,b=null,c=null,d=null,e=null,f=null,g=null,h=Array(6E3),k=h.length,l=0,m=k;m--;)h[m]=new RAPT.ParticleInstance;RAPT.Particle=function(){var a=l<k?h[l++]:h[k-1];a.init();return a};RAPT.Particle.reset=function(){l=0;for(var a=3E3;a--;)c[3*a+0]=0,c[3*a+1]=0,c[3*a+2]=0,g[4*a+3]=0};RAPT.Particle.init3d=function(h,k){b=new THREE.BufferGeometry;var l=THREE.AdditiveBlending;c=new Float32Array(9E3);f=new Float32Array(6E3);g=new Float32Array(12E3);d=new Float32Array(3E3);
e=new Float32Array(3E3);for(var m=3E3;m--;)e[m]=0.3,f[2*m+1]=1;b.addAttribute("position",new THREE.BufferAttribute(c,3));b.addAttribute("colors",new THREE.BufferAttribute(g,4));b.addAttribute("uvPos",new THREE.BufferAttribute(f,2));b.addAttribute("angle",new THREE.BufferAttribute(d,1));b.addAttribute("size",new THREE.BufferAttribute(e,1));a=new THREE.ShaderMaterial({uniforms:{ntiles:{type:"f",value:8},scale:{type:"f",value:800},map:{type:"t",value:null},alphaTest:{type:"f",value:0}},fragmentShader:["uniform sampler2D map;\nuniform float ntiles;\nuniform float alphaTest;\nvarying vec4 vColor;\nvarying vec2 vPos;\nvarying float vAngle;",
RAPT.tileUV,RAPT.rotUV,"void main(){\n    vec2 uv = rotUV(vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ), vAngle);\n    vec2 coord = tileUV(uv, vPos, ntiles);\n    vec4 texture = texture2D( map, coord );\n    gl_FragColor = texture * vColor;\n    if ( gl_FragColor.a <= alphaTest ) discard;\n}"].join("\n"),vertexShader:"attribute float angle;\nattribute vec4 colors;\nattribute vec2 uvPos;\nattribute float size;\nuniform float scale;\nvarying vec2 vPos;\nvarying vec4 vColor;\nvarying float vAngle;\nvoid main(){\n    vPos = uvPos;\n    vColor = colors;\n    vAngle = angle;\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n    gl_Position = projectionMatrix * mvPosition;\n}",
depthTest:!1,depthWrite:!0,transparent:!0,blending:l});a.uniforms.map.value=k;l=new THREE.PointCloud(b,a);l.position.set(0,0,0.01);l.frustumCulled=!1;h.add(l)};RAPT.Particle.tick=function(a){for(var b=0;b<l;b++){var k=h[b].tick(a);c[3*b+0]=h[b].m_pos.x.toFixed(3);c[3*b+1]=h[b].m_pos.y.toFixed(3);c[3*b+2]=h[b].m_pos.z.toFixed(3);g[4*b+0]=h[b].m_color.x;g[4*b+1]=h[b].m_color.y;g[4*b+2]=h[b].m_color.z;g[4*b+3]=h[b].m_color.w;0!==h[b].m_uvpos.x&&0!==h[b].m_uvpos.y?(f[2*b+0]=h[b].m_uvpos.x,f[2*b+1]=h[b].m_uvpos.y):
f[2*b+0]=2*h[b].m_type;d[b]=h[b].m_angle;e[b]=3*h[b].m_radius;k||(k=h[b],h[b]=h[l-1],g[4*(l-1)+3]=0,h[l-1]=k,l--,b--)}};RAPT.Particle.scalemat=function(b){a.uniforms.scale.value=b};RAPT.Particle.update=function(){b.attributes.position.needsUpdate=!0;b.attributes.colors.needsUpdate=!0;b.attributes.uvPos.needsUpdate=!0;b.attributes.angle.needsUpdate=!0;b.attributes.size.needsUpdate=!0};return RAPT.Particle}();RAPT.SpriteGroup=function(a){this.group=new THREE.Group;this.material=a.material?a.material:new THREE.MeshBasicMaterial({color:a.color,side:THREE.DoubleSide});this.size=a.size||1;this.group.scale.set(this.size,this.size,this.size);this.ydecal=a.ydecal||0;this.name=a.name;this.list=a.list;this.length=this.list.length;this.m={};this.sprite=[];for(var b,c,d,e,f,g=0;g<this.length;g++)b=a.list[g],c=[0,0],d=[0,0],e=[1,1,0],f=[0,0],a.pos&&(c=a.pos[g]),a.sizes&&(e=a.sizes[g]||a.sizes[0]),a.center&&(d=a.center[g]),
a.uvs&&(f=a.uvs[g]),this.m[b]=new RAPT.Box({name:b,size:e,pos:c,center:d,idx:g,nuv:a.nuv||1,uvs:f},this.material),this.sprite[g]=this.m[b];for(g=0;g<this.length;g++)b=a.list[g],c="",a.parent&&(c=a.parent[g]),c?this.m[c].add(this.m[b]):this.group.add(this.m[b]);RAPT.W3D.add(this)};
RAPT.SpriteGroup.prototype={constructor:RAPT.SpriteGroup,moveto:function(a){this.group.position.set(a.x,a.y+this.ydecal,0)},move:function(a,b){this.group.position.set(a,b+this.ydecal,0)},flip:function(a){a?this.group.scale.set(this.size,this.size,this.size):this.group.scale.set(-this.size,this.size,this.size)},clear:function(){var a,b,c,d,e;for(a=this.group.children.length;a--;){d=this.group.children[a];if(d.children.length)for(b=d.children.length;b--;){e=d.children[b];if(e.children.length)for(c=
e.children.length;c--;)e.remove(e.children[c]);d.remove(e)}this.group.remove(d)}for(a=this.sprite.length;a--;)this.sprite[a].clear();this.sprite=[]},visible:function(a){this.group.visible=a?!0:!1},remove:function(){RAPT.W3D.remove(this)}};
RAPT.Box=function(a,b){this.parent=null;var c=new THREE.PlaneBufferGeometry(a.size[0],a.size[1]);c.applyMatrix((new THREE.Matrix4).makeTranslation(a.center[0],a.center[1],0));THREE.Mesh.call(this,c,b);this.position.set(a.pos[0],a.pos[1],0.01*(a.pos[2]||0));this.nuv=a.nuv;1!==this.nuv&&this.changeuv(a.uvs[0],a.uvs[1])};RAPT.Box.prototype=Object.create(THREE.Mesh.prototype);RAPT.Box.prototype.constructor=RAPT.Box;RAPT.Box.prototype.addto=function(a){this.parent=a;this.parent.add(this.mesh)};
RAPT.Box.prototype.clear=function(){this.geometry.dispose()};RAPT.Box.prototype.changeuv=function(a,b){var c=1/this.nuv,d=a*c,e=1-b*c,c=[d,e,d+c,e-c];this.geometry.attributes.uv.array=new Float32Array([c[0],c[1],c[2],c[1],c[0],c[3],c[2],c[3]])};RAPT.tileUV="vec2 tileUV(vec2 uv, vec2 pos, float ntile){\n    pos.y = ntiles-pos.y-1.0;\n    vec2 sc = vec2(1.0/ntile, 1.0/ntile);\n    return vec2(uv*sc)+(pos*sc);\n}";RAPT.rotUV="vec2 rotUV(vec2 uv, float angle){\n    float s = sin(angle);\n    float c = cos(angle);\n    mat2 r = mat2( c, -s, s, c);\n    r *= 0.5; r += 0.5; r = r * 2.0 - 1.0;\n    uv -= 0.5; uv = uv * r; uv += 0.5;\n    return uv;\n}";RAPT.decalUV="vec2 decalUV(vec2 uv, float pix, float max){\n    float ps = uv.x / max;\n    float mx = uv.x / (uv.x-(ps*2.0));\n    vec2 decal = vec2( (ps*pix), - (ps*pix));\n    vec2 sc = vec2(uv.x*mx,uv.y*mx);\n    return (uv);\n}";
RAPT.MakeBasicShader=function(a){return{uniforms:{map:{type:"t",value:a.map||null},color:{type:"c",value:new THREE.Color(a.color||16777215)},alphaTest:{type:"f",value:a.alphaTest||0}},fragmentShader:"uniform sampler2D map;\nuniform vec3 color;\nuniform float alphaTest;\nvarying vec2 vUv;\nvoid main(){\n    vec4 diffuseColor = vec4(color, 1.0);\n    vec4 texelColor = texture2D(map, vUv);\n    diffuseColor *= texelColor;\n    gl_FragColor = diffuseColor;\n    if ( gl_FragColor.a < alphaTest ) discard;\n}",
vertexShader:"varying vec2 vUv;\nvoid main(){\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n}",side:a.side||THREE.FrontSide,transparent:a.transparent||!1,shading:THREE.FlatShading,lights:!1,fog:!1}};RAPT.Keyframe=function(a,b){this.center=new RAPT.Vector(a,b);this.angles=[]};
RAPT.Keyframe.prototype={constructor:RAPT.Keyframe,add:function(){for(var a=0;a<arguments.length;a++)this.angles.push(arguments[a]*RAPT.ToRad);return this},lerpWith:function(a,b){for(var c=new RAPT.Keyframe(RAPT.lerp(this.center.x,a.center.x,b),RAPT.lerp(this.center.y,a.center.y,b)),d=0;d<this.angles.length;d++)c.angles.push(RAPT.lerp(this.angles[d],a.angles[d],b));return c},lerp:function(a,b){var c=Math.floor(b);b-=c;c%=a.length;return a[c].lerpWith(a[(c+1)%a.length],b)}};RAPT.CELL_EMPTY=0;RAPT.CELL_SOLID=1;RAPT.CELL_FLOOR_DIAG_LEFT=2;RAPT.CELL_FLOOR_DIAG_RIGHT=3;RAPT.CELL_CEIL_DIAG_LEFT=4;RAPT.CELL_CEIL_DIAG_RIGHT=5;RAPT.Cell=function(a,b,c){this.x=a;this.y=b;this.type=c;this.supType=0;this.edges=[];this.ne=0};
RAPT.Cell.prototype={constructor:RAPT.Cell,bottomLeft:function(){return new RAPT.Vector(this.x,this.y)},bottomRight:function(){return new RAPT.Vector(this.x+1,this.y)},topLeft:function(){return new RAPT.Vector(this.x,this.y+1)},topRight:function(){return new RAPT.Vector(this.x+1,this.y+1)},ceilingOccupied:function(){return this.type===RAPT.CELL_SOLID||this.type===RAPT.CELL_CEIL_DIAG_LEFT||this.type===RAPT.CELL_CEIL_DIAG_RIGHT},floorOccupied:function(){return this.type===RAPT.CELL_SOLID||this.type===
RAPT.CELL_FLOOR_DIAG_LEFT||this.type===RAPT.CELL_FLOOR_DIAG_RIGHT},leftWallOccupied:function(){return this.type===RAPT.CELL_SOLID||this.type===RAPT.CELL_FLOOR_DIAG_LEFT||this.type===RAPT.CELL_CEIL_DIAG_LEFT},rightWallOccupied:function(){return this.type===RAPT.CELL_SOLID||this.type===RAPT.CELL_FLOOR_DIAG_RIGHT||this.type===RAPT.CELL_CEIL_DIAG_RIGHT},posDiagOccupied:function(){return this.type===RAPT.CELL_SOLID||this.type===RAPT.CELL_FLOOR_DIAG_RIGHT||this.type===RAPT.CELL_CEIL_DIAG_LEFT},negDiagOccupied:function(){return this.type===
RAPT.CELL_SOLID||this.type===RAPT.CELL_FLOOR_DIAG_LEFT||this.type===RAPT.CELL_CEIL_DIAG_RIGHT},addEdge:function(a){this.edges.push(a)},getLastEdge:function(){return this.edges[this.edges.length-1]},removeEdge:function(a){a=this.getEdge(a);this.edges.splice(a,1)},getBlockingEdges:function(a){for(var b=[],c=this.edges.length;c--;)this.edges[c].blocksColor(a)&&b.push(this.edges[c]);return b},getEdge:function(a){for(var b=this.edges.length;b--;){var c=this.edges[b];if(0.001>c.getStart().sub(a.getStart()).lengthSquared()&&
0.001>c.getEnd().sub(a.getEnd()).lengthSquared())return b}return-1},getShape:function(){var a=new RAPT.Vector(this.x,this.y),b=new RAPT.Vector(0,0),c=new RAPT.Vector(0,1),d=new RAPT.Vector(1,0),e=new RAPT.Vector(1,1);switch(this.type){case RAPT.CELL_SOLID:return new RAPT.Polygon(a,b,d,e,c);case RAPT.CELL_FLOOR_DIAG_LEFT:return new RAPT.Polygon(a,b,d,c);case RAPT.CELL_FLOOR_DIAG_RIGHT:return new RAPT.Polygon(a,b,d,e);case RAPT.CELL_CEIL_DIAG_LEFT:return new RAPT.Polygon(a,b,e,c);case RAPT.CELL_CEIL_DIAG_RIGHT:return new RAPT.Polygon(a,
c,d,e)}return null}};RAPT.ONE_WAY=0;RAPT.TWO_WAY=1;RAPT.Door=function(a,b,c,d,e){this.cells=[c,d];this.edges=[a,b];this.diag=e;this.d=[];c&&a&&this.add3dDoor(0,c,a);d&&b&&this.add3dDoor(1,d,b);this.toClose=this.toOpen=!1;this.posZ=0};
RAPT.Door.prototype={constructor:RAPT.Door,doorExists:function(a){if(null===this.edges[a])return!1;var b=this.cells[a];return null!==b&&-1!==b.getEdge(this.edges[a])},doorPut:function(a,b){if(null!==this.edges[a]&&!this.doorExists(a)){var c=this.cells[a];null!==c&&(c.addEdge(new RAPT.Edge(this.edges[a].getStart(),this.edges[a].getEnd(),this.edges[a].color)),this.toClose=!0,b&&RAPT.gameState.killAll(this.edges[a]),RAPT.gameState.recordModification())}},tick:function(a){this.toOpen&&(-0.5<this.posZ?
(this.posZ-=0.01,this.d[0]&&(this.d[0].position.z=this.posZ),this.d[1]&&(this.d[1].position.z=this.posZ)):this.toOpen=!1);this.toClose&&(0>this.posZ?(this.posZ+=0.01,this.d[0]&&(this.d[0].position.z=this.posZ),this.d[1]&&(this.d[1].position.z=this.posZ)):this.toClose=!1)},doorRemove:function(a){if(null!==this.edges[a]&&this.doorExists(a)){var b=this.cells[a];null!==b&&(b.removeEdge(this.edges[a]),this.remove3dDoor(a),RAPT.gameState.recordModification(),this.toOpen=!0)}},add3dDoor:function(a,b,c){var d=
b.x;b=b.y;var e=c.getStart(),f=c.getEnd(),g=c.color;c=c.getOrientation();0==this.diag?this.d[a]=new THREE.Mesh(RAPT.GEO.door0):(c=0,e.x<f.x&&(c=3),this.d[a]=4==this.diag?new THREE.Mesh(RAPT.GEO.door1):new THREE.Mesh(RAPT.GEO.door2));switch(c){case 1:this.d[a].rotation.z=-RAPT.PI90;break;case 2:this.d[a].rotation.z=RAPT.PI90;break;case 3:this.d[a].rotation.z=RAPT.PI;break;case 0:this.d[a].rotation.z=0}this.d[a].position.set(d+0.5,b+0.5,0);this.d[a].material=1==g?RAPT.MAT_DOOR_R:2==g?RAPT.MAT_DOOR_B:
RAPT.MAT_DOOR;RAPT.W3D.addDoor(this.d[a])},remove3dDoor:function(a){RAPT.W3D.scene.add(this.d[a])},act:function(a,b,c){for(b=0;2>b;++b)switch(a){case RAPT.DOORBELL_OPEN:this.doorRemove(b);break;case RAPT.DOORBELL_CLOSE:this.doorPut(b,c);break;case RAPT.DOORBELL_TOGGLE:this.doorExists(b)?this.doorRemove(b):this.doorPut(b,c)}}};RAPT.EDGE_FLOOR=0;RAPT.EDGE_LEFT=1;RAPT.EDGE_RIGHT=2;RAPT.EDGE_CEILING=3;RAPT.EDGE_NEUTRAL=0;RAPT.EDGE_RED=1;RAPT.EDGE_BLUE=2;RAPT.EDGE_PLAYERS=3;RAPT.EDGE_ENEMIES=4;RAPT.Edge=function(a,b,c,d){this.segment=new RAPT.Segment(a,b);this.color=c;this.type=d||0};
RAPT.Edge.prototype={constructor:RAPT.Edge,blocksColor:function(a){switch(this.color){case RAPT.EDGE_NEUTRAL:return!0;case RAPT.EDGE_RED:return a!=RAPT.EDGE_RED;case RAPT.EDGE_BLUE:return a!=RAPT.EDGE_BLUE;case RAPT.EDGE_PLAYERS:return a!=RAPT.EDGE_RED&&a!=RAPT.EDGE_BLUE;case RAPT.EDGE_ENEMIES:return a!=RAPT.EDGE_ENEMIES}return!1},getStart:function(){return this.segment.start},getEnd:function(){return this.segment.end},getOrientation:function(){return RAPT.getOrientation(this.segment.normal)}};
RAPT.getOrientation=function(a){return 0.9<a.x?RAPT.EDGE_LEFT:-0.9>a.x?RAPT.EDGE_RIGHT:0>a.y?RAPT.EDGE_CEILING:RAPT.EDGE_FLOOR};RAPT.SPAWN_POINT_PARTICLE_FREQ=0.3;RAPT.GAME_IN_PLAY=0;RAPT.GAME_WON=1;RAPT.GAME_LOST=2;RAPT.GAME_PAUSE=3;RAPT.STAT_PLAYER_DEATHS=0;RAPT.STAT_ENEMY_DEATHS=1;RAPT.STAT_COGS_COLLECTED=2;RAPT.STAT_NUM_COGS=3;RAPT.drawMinX=0;RAPT.drawMinY=0;RAPT.drawMaxX=0;RAPT.drawMaxY=0;
RAPT.GameState=function(){this.world=new RAPT.World;this.collider=new RAPT.CollisionDetector;this.edgeQuad=new RAPT.EdgeQuad;this.playerA=new RAPT.Player(new RAPT.Vector,RAPT.EDGE_RED);this.playerB=new RAPT.Player(new RAPT.Vector,RAPT.EDGE_BLUE);this.spawnPointParticleTimer=0;this.spawnPointOffset=new RAPT.Vector;this.enemies=[];this.doors=[];this.timeSinceStart=0;this.killKey=!1;this.modificationCount=0;this.gameStatus=RAPT.GAME_IN_PLAY;this.stats=[0,0,0,0]};
RAPT.GameState.prototype={constructor:RAPT.GameState,recordModification:function(){this.modificationCount++},getPlayer:function(a){return 0==a?this.playerA:this.playerB},getOtherPlayer:function(a){return a==this.playerA?this.playerB:this.playerA},getSpawnPoint:function(){return this.world.spawnPoint},setSpawnPoint:function(a){this.world.spawnPoint=new RAPT.Vector(a.x,a.y);this.spawnPointOffset.y=0.125;this.world.spawnPoint.y+=0.01;this.startPoint.move(this.world.spawnPoint.x-0.5,this.world.spawnPoint.y-
0.5)},gameWon:function(){var a=this.world.goal,b=!this.playerA.isDead()&&0.4>Math.abs(this.playerA.getCenter().x-a.x)&&0.4>Math.abs(this.playerA.getCenter().y-a.y),a=!this.playerB.isDead()&&0.4>Math.abs(this.playerB.getCenter().x-a.x)&&0.4>Math.abs(this.playerB.getCenter().y-a.y);return b&&a},gameLost:function(){return this.playerA.isDead()&&this.playerB.isDead()},incrementStat:function(a){++this.stats[a]},addEnemy:function(a,b){"undefined"===typeof b?b=a.getShape().getCenter():a.getShape()&&a.getShape().moveTo(b);
var c={ref:a.getCenter().sub(b)},d={ref:a.getVelocity()};this.collider.collideEntityWorld(a,c,d,a.getElasticity(),this.world,!0);a.setVelocity(d.ref);void 0!=a.getShape()&&a.getShape().moveBy(c.ref);this.enemies.push(a)},clearDoors:function(){this.doors=[]},addDoor:function(a,b,c,d,e){var f,g,h=!0,k=0;if(a.y+1==b.y&&a.x==b.x){if(f=this.world.getCell(a.x,a.y),g=this.world.getCell(a.x-1,a.y),!f||!g||f.leftWallOccupied()||g.rightWallOccupied())h=!1}else if(a.y-1==b.y&&a.x==b.x){if(f=this.world.getCell(a.x-
1,b.y),g=this.world.getCell(a.x,b.y),!f||!g||f.rightWallOccupied()||g.leftWallOccupied())h=!1}else if(a.x+1==b.x&&a.y==b.y){if(f=this.world.getCell(a.x,a.y-1),g=this.world.getCell(a.x,a.y),!f||!g||f.ceilingOccupied()||g.floorOccupied())h=!1}else if(a.x-1==b.x&&a.y==b.y){if(f=this.world.getCell(b.x,a.y),g=this.world.getCell(b.x,a.y-1),!f||!g||f.floorOccupied()||g.ceilingOccupied())h=!1}else{g=a.x<b.x?a.x:b.x;var l=a.y<b.y?a.y:b.y;f=this.world.getCell(g,l);g=this.world.getCell(g,l);a.x<b.x===a.y<b.y?
!f||f.posDiagOccupied()?h=!1:k=4:!f||f.negDiagOccupied()?h=!1:k=5}a=h?c===RAPT.ONE_WAY?new RAPT.Door(new RAPT.Edge(a,b,d),null,f,null,k):new RAPT.Door(new RAPT.Edge(a,b,d),new RAPT.Edge(b,a,d),f,g,k):new RAPT.Door(null,null,null,null,k);this.doors.push(a);e||a.act(RAPT.DOORBELL_CLOSE,!0,!1)},getDoor:function(a){return this.doors[a]},killAll:function(a){var b;for(b=0;2>b;++b)this.collider.intersectEntitySegment(this.getPlayer(b),a.segment)&&this.getPlayer(b).setDead(!0);for(b=this.enemies.length;b--;){var c=
this.enemies[b];c.canCollide()&&this.collider.intersectEntitySegment(c,a.segment)&&c.setDead(!0)}},tick:function(a){var b;if(this.gameStatus===RAPT.GAME_WON||this.gameWon())this.gameStatus=RAPT.GAME_WON;else if(this.gameStatus===RAPT.GAME_LOST||this.gameLost())this.gameStatus=RAPT.GAME_LOST;this.timeSinceStart+=a;this.killKey&&(this.playerA.setDead(!0),this.playerB.setDead(!0));this.playerA.tick(a);this.playerB.tick(a);for(b=this.doors.length;b--;)this.doors[b].tick(a);for(b=this.enemies.length;b--;)this.enemies[b].tick(a);
for(b=this.enemies.length;b--;)this.enemies[b].isDead()&&this.enemies.splice(b,1);this.spawnPointParticleTimer-=a;0>=this.spawnPointParticleTimer&&(a=this.world.spawnPoint.sub(new RAPT.Vector(0,0.25)),RAPT.Particle().position(a).velocity(new RAPT.Vector(RAPT.randInRange(-0.3,0.3),0.3)).radius(0.03,0.05).bounces(0).decay(0.1,0.2).color(1,1,1,1).circle().gravity(-5),this.spawnPointParticleTimer+=RAPT.SPAWN_POINT_PARTICLE_FREQ)},addSpawnPoint:function(a){this.startPoint=new RAPT.SpriteGroup({name:"start",
material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[14,2],[15,2],[14,3],[15,3]],list:["p1","p2","p3","p4"],sizes:[[1,1]],pos:[[0,1,0.1],[1,1,0.1],[0,0,0.1],[1,0,0.1]]});this.startPoint.moveto(a)},addGoal:function(a){(new RAPT.SpriteGroup({name:"end",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[14,1]],list:["p1"],sizes:[[1,1]],pos:[[0.5,0.5,-0.24]]})).moveto(a)},getInfo:function(){var a={};a[0]=this.playerA.getInfo();a[1]=this.playerB.getInfo();return a},message:function(a){RAPT.MESSAGE.innerHTML=a},reset:function(){RAPT.Particle.reset();
this.timeSinceStart=this.spawnPointParticleTimer=0;this.spawnPointOffset=new RAPT.Vector;this.enemies=[];this.doors=[];this.killKey=!1;this.modificationCount=0;this.gameStatus=RAPT.GAME_IN_PLAY;this.stats=[0,0,0,0]},loadLevelFromJSON:function(a){this.reset();var b=a.width,c=a.height,d,e=this.jsonToVec(a.start),f=this.jsonToVec(a.end);for(this.world.init(b,c,e,f);b--;)for(d=c;d--;){var g=a.cells[d][b];this.world.setCell(b,d,g);g!==RAPT.CELL_SOLID&&(this.world.safety=new RAPT.Vector(b+0.5,d+0.5))}this.world.createAllEdges();
RAPT.W3D.initLevel(this.world);this.playerA.reset(this.world.spawnPoint,RAPT.EDGE_RED);this.playerB.reset(this.world.spawnPoint,RAPT.EDGE_BLUE);this.playerA.add3d();this.playerB.add3d();this.addSpawnPoint(e);this.addGoal(f);for(c=0;c<a.entities.length;++c)switch(e=a.entities[c],e["class"]){case "cog":this.enemies.push(new RAPT.GoldenCog(this.jsonToVec(e.pos)));break;case "wall":RAPT.gameState.addDoor(this.jsonToVec(e.end),this.jsonToVec(e.start),e.oneway?RAPT.ONE_WAY:RAPT.TWO_WAY,e.color,e.open);
break;case "button":f=new RAPT.Doorbell(this.jsonToVec(e.pos),e.type,!0);f.doors=e.walls;this.enemies.push(f);break;case "sign":this.enemies.push(new RAPT.HelpSign(this.jsonToVec(e.pos),e.text));break;case "enemy":this.enemies.push(this.jsonToEnemy(e))}},jsonToTarget:function(a){return 1===a.color?RAPT.gameState.playerA:RAPT.gameState.playerB},jsonToVec:function(a){return new RAPT.Vector(a[0],a[1])},jsonToEnemy:function(a){var b=this.jsonToVec(a.pos);switch(a.type){case "bomber":return new RAPT.Bomber(b,
a.angle);case "bouncy rocket launcher":return new RAPT.BouncyRocketLauncher(b,this.jsonToTarget(a));case "corrosion cloud":return new RAPT.CorrosionCloud(b,this.jsonToTarget(a));case "doom magnet":return new RAPT.DoomMagnet(b);case "grenadier":return new RAPT.Grenadier(b,this.jsonToTarget(a));case "jet stream":return new RAPT.JetStream(b,a.angle);case "headache":return new RAPT.Headache(b,this.jsonToTarget(a));case "hunter":return new RAPT.Hunter(b);case "multi gun":return new RAPT.MultiGun(b);case "popper":return new RAPT.Popper(b);
case "rocket spider":return new RAPT.RocketSpider(b,a.angle);case "shock hawk":return new RAPT.ShockHawk(b,this.jsonToTarget(a));case "spike ball":return new RAPT.SpikeBall(b);case "stalacbat":return new RAPT.Stalacbat(b,this.jsonToTarget(a));case "wall avoider":return new RAPT.WallAvoider(b,this.jsonToTarget(a));case "wall crawler":return new RAPT.WallCrawler(b,a.angle);case "wheeligator":return new RAPT.Wheeligator(b,a.angle);default:return console.log("Invalid enemy type in level"),new RAPT.SpikeBall(b)}}};RAPT.WORLD_MARGIN=60;RAPT.World=function(a,b,c,d){this.cells=null;this.totalEdge=this.height=this.width=0;this.safety=new RAPT.Vector;this.spawnPoint=new RAPT.Vector;this.goal=new RAPT.Vector};
RAPT.World.prototype={constructor:RAPT.World,init:function(a,b,c,d){this.cells=Array(a);for(var e=0;e<a;++e){this.cells[e]=Array(b);for(var f=0;f<b;++f)this.cells[e][f]=new RAPT.Cell(e,f,RAPT.CELL_SOLID)}this.width=a;this.height=b;this.safety=c;this.totalEdge=0;this.spawnPoint=c.add(new RAPT.Vector(0.5,0.5));this.goal=d.add(new RAPT.Vector(0.5,0.5))},getCellNE:function(a,b){return 0<=a&&0<=b&&a<this.width&&b<this.height?this.cells[a][b].ne:0},setCellNE:function(a,b,c){a=this.getCell(a,b);null!==a&&
(a.ne=c)},getCell:function(a,b){return 0<=a&&0<=b&&a<this.width&&b<this.height?this.cells[a][b]:null},getCellType:function(a,b){return 0<=a&&0<=b&&a<this.width&&b<this.height?this.cells[a][b].type:RAPT.CELL_SOLID},getEdges:function(a,b){return 0<=a&&0<=b&&a<this.width&&b<this.height?this.cells[a][b].edges:[]},setCell:function(a,b,c){this.cells[a][b]=new RAPT.Cell(a,b,c)},createAllEdges:function(){for(var a=this.totalEdge=0;a<this.cells.length;a++)for(var b=0;b<this.cells[0].length;b++)this.cells[a][b].edges=
this.createEdges(a,b),this.totalEdge+=this.cells[a][b].edges.length},createEdges:function(a,b){var c=[],d=this.getCellType(a,b),e=this.getCellType(a-1,b),f=this.getCellType(a,b-1),g=this.getCellType(a+1,b),h=this.getCellType(a,b+1),k=new RAPT.Vector(a,b),l=new RAPT.Vector(a+1,b),m=new RAPT.Vector(a,b+1),n=new RAPT.Vector(a+1,b+1);this.IS_EMPTY_XNEG(d)&&this.IS_SOLID_XPOS(e)&&(c.push(new RAPT.Edge(k,m,RAPT.EDGE_NEUTRAL,1)),this.setCellNE(a-1,b,1),this.setCellNE(a-1,b-1,1),this.setCellNE(a-1,b+1,1));
this.IS_EMPTY_YNEG(d)&&this.IS_SOLID_YPOS(f)&&(c.push(new RAPT.Edge(l,k,RAPT.EDGE_NEUTRAL,2)),this.setCellNE(a,b-1,1));this.IS_EMPTY_XPOS(d)&&this.IS_SOLID_XNEG(g)&&(c.push(new RAPT.Edge(n,l,RAPT.EDGE_NEUTRAL,0)),this.setCellNE(a+1,b,1),this.setCellNE(a+1,b-1,1),this.setCellNE(a+1,b+1,1));this.IS_EMPTY_YPOS(d)&&this.IS_SOLID_YNEG(h)&&(c.push(new RAPT.Edge(m,n,RAPT.EDGE_NEUTRAL,3)),this.setCellNE(a,b+1,1));d==RAPT.CELL_FLOOR_DIAG_RIGHT?(c.push(new RAPT.Edge(n,k,RAPT.EDGE_NEUTRAL,4)),this.setCellNE(a,
b-1,1),this.setCellNE(a,b+1,1)):d==RAPT.CELL_CEIL_DIAG_LEFT?(c.push(new RAPT.Edge(k,n,RAPT.EDGE_NEUTRAL,6)),this.setCellNE(a,b-1,1),this.setCellNE(a,b+1,1)):d==RAPT.CELL_FLOOR_DIAG_LEFT?(c.push(new RAPT.Edge(l,m,RAPT.EDGE_NEUTRAL,5)),this.setCellNE(a,b-1,1),this.setCellNE(a,b+1,1)):d==RAPT.CELL_CEIL_DIAG_RIGHT&&(c.push(new RAPT.Edge(m,l,RAPT.EDGE_NEUTRAL,7)),this.setCellNE(a,b-1,1),this.setCellNE(a,b+1,1));return c},getEdgesInAabb:function(a,b){for(var c=Math.max(0,Math.floor(a.getLeft())),d=Math.max(0,
Math.floor(a.getBottom())),e=Math.min(this.width,Math.ceil(a.getRight())),f=Math.min(this.height,Math.ceil(a.getTop())),g=[];c<e;c++)for(var h=d;h<f;h++)g=g.concat(this.cells[c][h].getBlockingEdges(b));return g},getCellsInAabb:function(a){var b=Math.max(0,Math.floor(a.getLeft())),c=Math.max(0,Math.floor(a.getBottom())),d=Math.min(this.width,Math.ceil(a.getRight()));a=Math.min(this.height,Math.ceil(a.getTop()));for(var e=[];b<d;b++)for(var f=c;f<a;f++)e=e.concat(this.cells[b][f]);return e},getHugeAabb:function(){return new RAPT.AABB(new RAPT.Vector(-RAPT.WORLD_MARGIN,
-RAPT.WORLD_MARGIN),new RAPT.Vector(this.width+RAPT.WORLD_MARGIN,this.height+RAPT.WORLD_MARGIN))},getWidth:function(){return this.width},getHeight:function(){return this.height},IS_EMPTY_XNEG:function(a){return a==RAPT.CELL_EMPTY||a==RAPT.CELL_FLOOR_DIAG_RIGHT||a==RAPT.CELL_CEIL_DIAG_RIGHT},IS_EMPTY_YNEG:function(a){return a==RAPT.CELL_EMPTY||a==RAPT.CELL_CEIL_DIAG_LEFT||a==RAPT.CELL_CEIL_DIAG_RIGHT},IS_EMPTY_XPOS:function(a){return a==RAPT.CELL_EMPTY||a==RAPT.CELL_FLOOR_DIAG_LEFT||a==RAPT.CELL_CEIL_DIAG_LEFT},
IS_EMPTY_YPOS:function(a){return a==RAPT.CELL_EMPTY||a==RAPT.CELL_FLOOR_DIAG_LEFT||a==RAPT.CELL_FLOOR_DIAG_RIGHT},IS_SOLID_XNEG:function(a){return a==RAPT.CELL_SOLID||a==RAPT.CELL_FLOOR_DIAG_LEFT||a==RAPT.CELL_CEIL_DIAG_LEFT},IS_SOLID_YNEG:function(a){return a==RAPT.CELL_SOLID||a==RAPT.CELL_FLOOR_DIAG_LEFT||a==RAPT.CELL_FLOOR_DIAG_RIGHT},IS_SOLID_XPOS:function(a){return a==RAPT.CELL_SOLID||a==RAPT.CELL_FLOOR_DIAG_RIGHT||a==RAPT.CELL_CEIL_DIAG_RIGHT},IS_SOLID_YPOS:function(a){return a==RAPT.CELL_SOLID||
a==RAPT.CELL_CEIL_DIAG_LEFT||a==RAPT.CELL_CEIL_DIAG_RIGHT}};RAPT.MAX_SPAWN_FORCE=100;RAPT.INNER_SPAWN_RADIUS=1;RAPT.OUTER_SPAWN_RADIUS=1.1;RAPT.ENEMY_BOMB=0;RAPT.ENEMY_BOMBER=1;RAPT.ENEMY_BOUNCY_ROCKET=2;RAPT.ENEMY_BOUNCY_ROCKET_LAUNCHER=3;RAPT.ENEMY_CLOUD=4;RAPT.ENEMY_MAGNET=5;RAPT.ENEMY_GRENADE=6;RAPT.ENEMY_GRENADIER=7;RAPT.ENEMY_HEADACHE=8;RAPT.ENEMY_HELP_SIGN=9;RAPT.ENEMY_HUNTER=10;RAPT.ENEMY_LASER=11;RAPT.ENEMY_MULTI_GUN=12;RAPT.ENEMY_POPPER=13;RAPT.ENEMY_RIOT_BULLET=14;RAPT.ENEMY_JET_STREAM=15;RAPT.ENEMY_ROCKET=16;RAPT.ENEMY_ROCKET_SPIDER=17;
RAPT.ENEMY_ROLLER_BEAR=18;RAPT.ENEMY_SHOCK_HAWK=19;RAPT.ENEMY_SPIKE_BALL=20;RAPT.ENEMY_STALACBAT=21;RAPT.ENEMY_WALL_AVOIDER=22;RAPT.ENEMY_CRAWLER=23;RAPT.ENEMY_WHEELIGATOR=24;RAPT.ENEMY_DOORBELL=25;RAPT.Enemy=function(a,b){this.velocity=new RAPT.Vector(0,0);this._isDead=!1;this.type=a;this.elasticity=b;this.shape=null};
RAPT.Enemy.prototype={constructor:RAPT.Enemy,getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity=a},isDead:function(){return this._isDead},setDead:function(a){if(this._isDead!==a)if(this._isDead=a)this.onDeath();else this.onRespawn()},getShape:function(){console.log("Enemy.getShape() unimplemented")},getCenter:function(){var a=this.getShape();return a?a.getCenter():new RAPT.Vector(0,0)},setCenter:function(a){this.getShape().moveTo(a)},isOnFloor:function(){RAPT.gameState.collider.onEntityWorld(this,
RAPT.gameState.edgeQuad,RAPT.gameState.world);return null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR]},onRespawn:function(){},tick:function(a){this.avoidsSpawn()&&this.setVelocity(this.getVelocity().add(this.avoidSpawnForce().mul(a)));var b={ref:this.move(a)},c={ref:this.getVelocity()},d=this.getShape();if(void 0!=d){var e=null;this.canCollide()&&(e=RAPT.gameState.collider.collideEntityWorld(this,b,c,this.elasticity,RAPT.gameState.world,!0),this.setVelocity(c.ref));d.moveBy(b.ref);null!==e&&this.reactToWorld(e);
RAPT.gameState.collider.containsPointShape(d.getCenter(),RAPT.gameState.world.getHugeAabb())||this.setDead(!0);if(!this.isDead())for(b=RAPT.gameState.collider.overlapShapePlayers(d),c=0;c<b.length;++c)b[c].isDead()||this.reactToPlayer(b[c])}this.afterTick(a)},getColor:function(){return RAPT.EDGE_ENEMIES},getElasticity:function(){return this.elasticity},getType:function(){return this.type},getTarget:function(){return-1},setTarget:function(a){},onDeath:function(){},canCollide:function(){return!0},avoidsSpawn:function(){return!1},
accelerate:function(a,b){this.setVelocity(this.velocity.add(a.mul(b)));return this.velocity.mul(b)},avoidSpawnForce:function(){var a=RAPT.gameState.getSpawnPoint().sub(this.getCenter()),b=this.getShape().radius,b=a.length()-b;return b<RAPT.INNER_SPAWN_RADIUS?a.unit().mul(-RAPT.MAX_SPAWN_FORCE):b<RAPT.OUTER_SPAWN_RADIUS?(b=RAPT.MAX_SPAWN_FORCE*(1-(b-RAPT.INNER_SPAWN_RADIUS)/(RAPT.OUTER_SPAWN_RADIUS-RAPT.INNER_SPAWN_RADIUS)),a.unit().mul(-b)):new RAPT.Vector(0,0)},move:function(a){return new RAPT.Vector(0,
0)},reactToWorld:function(a){},reactToPlayer:function(a){a.setDead(!0)},afterTick:function(a){}};RAPT.HoveringEnemy=function(a,b,c,d){RAPT.Enemy.call(this,a,d);this.hitCircle=new RAPT.Circle(b,c)};RAPT.HoveringEnemy.prototype=Object.create(RAPT.Enemy.prototype);RAPT.HoveringEnemy.prototype.constructor=RAPT.HoveringEnemy;RAPT.HoveringEnemy.prototype.getShape=function(){return this.hitCircle};RAPT.FREEFALL_ACCEL=-6;
RAPT.FreefallEnemy=function(a,b,c,d){RAPT.Enemy.call(this,a,d);this.hitCircle=new RAPT.Circle(b,c)};RAPT.FreefallEnemy.prototype=Object.create(RAPT.Enemy.prototype);RAPT.FreefallEnemy.prototype.constructor=RAPT.FreefallEnemy;RAPT.FreefallEnemy.prototype.getShape=function(){return this.hitCircle};RAPT.FreefallEnemy.prototype.move=function(a){return this.accelerate(new RAPT.Vector(0,RAPT.FREEFALL_ACCEL),a)};RAPT.FreefallEnemy.prototype.reactToWorld=function(a){this.setDead(!0)};
RAPT.FreefallEnemy.prototype.reactToPlayer=function(a){this.setDead(!0);a.setDead(!0)};RAPT.WalkingEnemy=function(a,b,c,d){RAPT.Enemy.call(this,a,d);this.hitCircle=new RAPT.Circle(b,c)};RAPT.WalkingEnemy.prototype=Object.create(RAPT.Enemy.prototype);RAPT.WalkingEnemy.prototype.constructor=RAPT.WalkingEnemy;RAPT.WalkingEnemy.prototype.getShape=function(){return this.hitCircle};RAPT.WalkingEnemy.prototype.move=function(a){return this.velocity.mul(a)};
RAPT.SpawningEnemy=function(a,b,c,d,e,f,g){RAPT.Enemy.call(this,a,e);this.spawnFrequency=f;this.timeUntilNextSpawn=g;this.hitBox=RAPT.makeAABB(b,c,d)};RAPT.SpawningEnemy.prototype=Object.create(RAPT.Enemy.prototype);RAPT.SpawningEnemy.prototype.constructor=RAPT.SpawningEnemy;RAPT.SpawningEnemy.prototype.getShape=function(){return this.hitBox};RAPT.SpawningEnemy.prototype.getReloadPercentage=function(){return 1-this.timeUntilNextSpawn/this.spawnFrequency};
RAPT.SpawningEnemy.prototype.tick=function(a){this.timeUntilNextSpawn-=a;0>=this.timeUntilNextSpawn&&(this.spawn()?this.timeUntilNextSpawn+=this.spawnFrequency:this.timeUntilNextSpawn=0);RAPT.Enemy.prototype.tick.call(this,a)};RAPT.SpawningEnemy.prototype.reactToPlayer=function(a){};RAPT.SpawningEnemy.prototype.spawn=function(){throw"SpawningEnemy.spawn() unimplemented";};RAPT.RotatingEnemy=function(a,b,c,d,e){RAPT.Enemy.call(this,a,e);this.hitCircle=new RAPT.Circle(b,c);this.heading=d};
RAPT.RotatingEnemy.prototype=Object.create(RAPT.Enemy.prototype);RAPT.RotatingEnemy.prototype.constructor=RAPT.RotatingEnemy;RAPT.RotatingEnemy.prototype.getShape=function(){return this.hitCircle};RAPT.PAUSE_AFTER_DEATH=2;RAPT.RESPAWN_INTERPOLATION_TIME=1;RAPT.PAUSE_BEFORE_RESPAWN=0.3;RAPT.PLAYER_ACCELERATION=50;RAPT.PLAYER_MAX_SPEED=8;RAPT.PLAYER_WIDTH=0.2;RAPT.PLAYER_HEIGHT=0.75;RAPT.PLAYER_SUPER_JUMP_SPEED=10;RAPT.PLAYER_CLAMBER_ACCEL_X=5;RAPT.PLAYER_CLAMBER_ACCEL_Y=10;RAPT.PLAYER_DEATH_SPEED=15;RAPT.PLAYER_GRAVITY=10;RAPT.SLIDE_PARTICLE_TIMER_PERIOD=0.2;RAPT.SUPER_PARTICLE_TIMER_PERIOD=0.025;RAPT.JUMP_MIN_WAIT=0.5;RAPT.WALL_FRICTION=0.1;RAPT.PLAYER_STATE_FLOOR=0;RAPT.PLAYER_STATE_AIR=1;
RAPT.PLAYER_STATE_CLAMBER=2;RAPT.PLAYER_STATE_LEFT_WALL=3;RAPT.PLAYER_STATE_RIGHT_WALL=4;RAPT.runningKeyframes=[(new RAPT.Keyframe(0,-0.1)).add(5,-10,65,-55,20,40,-20,-30,-30,10),(new RAPT.Keyframe(0,-0.04)).add(5,-10,35,-25,0,30,18,-110,0,20),(new RAPT.Keyframe(0,0)).add(5,-10,10,-30,-20,20,60,-100,10,30),(new RAPT.Keyframe(0,-0.1)).add(5,-10,-20,-30,-30,10,65,-55,20,40),(new RAPT.Keyframe(0,-0.04)).add(5,-10,18,-110,0,20,35,-25,0,30),(new RAPT.Keyframe(0,0)).add(5,-10,60,-100,10,30,10,-30,-20,20)];
RAPT.jumpingKeyframes=[(new RAPT.Keyframe(0,0)).add(0,-10,150,-170,-40,30,-30,-20,20,150),(new RAPT.Keyframe(0,0)).add(-20,10,60,-100,-80,30,30,-20,30,30)];RAPT.wallSlidingKeyframe=(new RAPT.Keyframe((0.4-RAPT.PLAYER_WIDTH)/2,0)).add(0,-10,150,-130,140,50,50,-30,50,130);RAPT.crouchingKeyframe=(new RAPT.Keyframe(0,-0.25)).add(30,-30,130,-110,-30,40,60,-130,20,20);
RAPT.fallingKeyframes=[(new RAPT.Keyframe(0,0)).add(-20,5,10,-30,-120,-30,40,-20,120,30),(new RAPT.Keyframe(0,0)).add(-20,5,10,-30,-130,-60,40,-20,150,50)];RAPT.clamberingKeyframes=[(new RAPT.Keyframe((0.4-RAPT.PLAYER_WIDTH)/2,0)).add(0,-10,150,-130,140,50,50,-30,50,130),(new RAPT.Keyframe(0,-0.2)).add(30,-30,160,-180,-30,40,20,-10,20,20)];RAPT.Player=function(a,b){this.velocity=new RAPT.Vector(0,0);this._isDead=!1;this.reset(a,b);this.info=[0,0,0];this.sprite=null};
RAPT.Player.prototype={constructor:RAPT.Player,getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity=a},isDead:function(){return this._isDead},setDead:function(a){if(this._isDead!==a)if(this._isDead=a)this.onDeath();else this.onRespawn()},getCenter:function(){return this.getShape().getCenter()},setCenter:function(a){this.getShape().moveTo(a)},isOnFloor:function(){RAPT.gameState.collider.onEntityWorld(this,RAPT.gameState.edgeQuad,RAPT.gameState.world);return null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR]},
add3d:function(){var a=[[0,0],[0,1],[1,0],[1,1],[2,0],[2,1],[1,0],[1,1],[2,0],[2,1],[3,2]];1==this.color&&(a=[[0,2],[0,3],[1,2],[1,3],[2,2],[2,3],[1,2],[1,3],[2,2],[2,3],[3,2]]);this.sprite=new RAPT.SpriteGroup({name:"player"+this.color,material:RAPT.MAT_PLAYER,size:0.4,ydecal:0.2,color:1==this.color?16711680:255,list:"head torso uplegl lowlegl uparml lowarml uplegr lowlegr uparmr lowarmr sabre".split(" "),parent:"torso  torso uplegl torso uparml torso uplegr torso uparmr lowarml".split(" "),nuv:4,
uvs:a,pos:[[0,0.5,0],[0,0,0],[-0.02,-0.26,1],[0,-0.5,1],[-0.05,0.4,2],[0,-0.4,2],[0.05,-0.25,-1],[0,-0.5,-1],[-0.05,0.4,-2],[0,-0.4,-2],[0,-0.5,-1]],center:[[0,0.25],[0,0],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0.25,0]]})},reset:function(a,b){this.sprite&&this.sprite.remove();this.rightKey=this.leftKey=this.crouchKey=this.jumpKey=this._isDead=!1;this.polygon=new RAPT.Polygon(a,new RAPT.Vector(RAPT.PLAYER_WIDTH/2,RAPT.PLAYER_HEIGHT/2),new RAPT.Vector(-RAPT.PLAYER_WIDTH/
2,RAPT.PLAYER_HEIGHT/2),new RAPT.Vector(0,-RAPT.PLAYER_HEIGHT/2));this.velocity=new RAPT.Vector(0,0);this.actualVelocity=new RAPT.Vector(0,0);this.boostMagnitude=this.boostTime=this.boost=0;this.jumpDisabled=this.onDiagLastTick=!1;this.lastContact=null;this.prevState=this.state=RAPT.PLAYER_STATE_FLOOR;this.facingRight=!1;this.timeSinceDeath=this.crouchTimer=this.fallingFrame=this.runningFrame=0;this.positionOfDeath=new RAPT.Vector(0,0);this.superJumpParticleTimer=this.slideParticleTimer=0;this.isSuperJumping=
!1;this.color=b},getShape:function(){return this.polygon},getColor:function(){return this.color},getPlayerIndex:function(){return this==RAPT.gameState.playerB},getCrouch:function(){return this.crouchKey},disableJump:function(){this.jumpDisabled=!0},addToVelocity:function(a){this.velocity.inplaceAdd(a)},collideWithOtherPlayer:function(){var a=RAPT.gameState.getOtherPlayer(this);if(a.crouchKey&&!a.isDead()&&this.state==RAPT.PLAYER_STATE_FLOOR&&a.state==RAPT.PLAYER_STATE_FLOOR){if(0.01>a.velocity.lengthSquared()&&
4<Math.abs(this.velocity.x)){var b=this.getCenter().sub(a.getCenter());0.01>=Math.abs(b.y)&&0.1>Math.abs(b.x)&&(this.velocity=new RAPT.Vector(0,RAPT.PLAYER_SUPER_JUMP_SPEED),this.isSuperJumping=!0)}1>this.getCenter().sub(a.getCenter()).lengthSquared()&&1<this.crouchTimer&&a.crouchTimer>=this.crouchTimer&&RAPT.gameState.setSpawnPoint(a.getCenter())}},tick:function(a){this.tickDeath(a);this.isDead()||(this.tickPhysics(a),this.tickParticles(a),this.tickAnimation(a))},tickDeath:function(a){this.isDead()?
this.timeSinceDeath+=a:this.timeSinceDeath=0;this.timeSinceDeath>RAPT.PAUSE_AFTER_DEATH+RAPT.RESPAWN_INTERPOLATION_TIME+RAPT.PAUSE_BEFORE_RESPAWN&&!RAPT.gameState.getOtherPlayer(this).isDead()&&this.setDead(!1);if(this.isDead()){a=RAPT.gameState.getSpawnPoint();var b=(this.timeSinceDeath-RAPT.PAUSE_AFTER_DEATH)/RAPT.RESPAWN_INTERPOLATION_TIME,b=Math.max(0,Math.min(1,b)),b=0.5-0.5*Math.cos(b*Math.PI),b=0.5-0.5*Math.cos(b*Math.PI);this.setCenter((new RAPT.Vector).lerp(this.positionOfDeath,a,b))}},tickPhysics:function(a){null!=
this.lastContact&&(this.boostTime=this.boostMagnitude=0);this.boostTime-=a;0>this.boostTime&&(this.boostMagnitude*=Math.pow(0.1,a));if(null!=this.lastContact||0>this.velocity.y)this.isSuperJumping=!1;var b=this.leftKey&&!this.rightKey&&!this.crouchKey,c=this.rightKey&&!this.leftKey&&!this.crouchKey;RAPT.gameState.collider.onEntityWorld(this,RAPT.gameState.edgeQuad,RAPT.gameState.world);var d=null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR]||null!=this.lastContact&&RAPT.getOrientation(this.lastContact.normal)==
RAPT.EDGE_FLOOR,e=null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_LEFT]||null!=this.lastContact&&RAPT.getOrientation(this.lastContact.normal)==RAPT.EDGE_LEFT,f=null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_RIGHT]||null!=this.lastContact&&RAPT.getOrientation(this.lastContact.normal)==RAPT.EDGE_RIGHT,g=null!=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_CEILING]||null!=this.lastContact&&RAPT.getOrientation(this.lastContact.normal)==RAPT.EDGE_CEILING;if(!this.jumpDisabled&&this.jumpKey)if(d){this.velocity.y=
6.5;this.boostMagnitude=this.boost=this.boostTime=0;if(e||f)this.boostTime=0.5,this.boost=1,this.boostMagnitude=0.5;f&&(this.boost=-this.boost);RAPT.gameState.getOtherPlayer(this).isSuperJumping&&(this.velocity.y=RAPT.PLAYER_SUPER_JUMP_SPEED,this.isSuperJumping=!0)}else e&&!b&&0>this.boostTime?(this.velocity=new RAPT.Vector(3.5,6.5),this.boostTime=RAPT.JUMP_MIN_WAIT,this.boost=2.5,this.boostMagnitude=1):f&&!c&&0>this.boostTime&&(this.velocity=new RAPT.Vector(-3.5,6.5),this.boostTime=RAPT.JUMP_MIN_WAIT,
this.boost=-2.5,this.boostMagnitude=1);g&&(this.boostMagnitude=this.boost=this.boostTime=0);if(d||!g)b&&(this.velocity.x-=RAPT.PLAYER_ACCELERATION*a,this.velocity.x=Math.max(this.velocity.x,-RAPT.PLAYER_MAX_SPEED)),c&&(this.velocity.x+=RAPT.PLAYER_ACCELERATION*a,this.velocity.x=Math.min(this.velocity.x,RAPT.PLAYER_MAX_SPEED));this.state=RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR]?RAPT.PLAYER_STATE_FLOOR:RAPT.gameState.edgeQuad.edges[RAPT.EDGE_LEFT]?RAPT.PLAYER_STATE_LEFT_WALL:RAPT.gameState.edgeQuad.edges[RAPT.EDGE_RIGHT]?
RAPT.PLAYER_STATE_RIGHT_WALL:RAPT.PLAYER_STATE_AIR;b={};c={};d=RAPT.gameState.collider.closestToEntityWorld(this,0.1,c,b,RAPT.gameState.world);if(this.state==RAPT.PLAYER_STATE_LEFT_WALL||this.state==RAPT.PLAYER_STATE_RIGHT_WALL)0>this.velocity.y&&(this.velocity.y*=Math.pow(RAPT.WALL_FRICTION,a)),-0.5<this.velocity.y&&this.prevState===RAPT.PLAYER_STATE_CLAMBER&&(this.state=RAPT.PLAYER_STATE_CLAMBER);this.state==RAPT.PLAYER_STATE_AIR&&0.01>d&&c.ref.y>b.ref.y&&(this.state=RAPT.PLAYER_STATE_CLAMBER);
this.state==RAPT.PLAYER_STATE_CLAMBER&&(this.leftKey&&0>b.ref.x-this.polygon.getCenter().x&&(this.velocity.x-=RAPT.PLAYER_CLAMBER_ACCEL_X*a,this.velocity.y+=RAPT.PLAYER_CLAMBER_ACCEL_Y*a),this.rightKey&&0<b.ref.x-this.polygon.getCenter().x&&(this.velocity.x+=RAPT.PLAYER_CLAMBER_ACCEL_X*a,this.velocity.y+=RAPT.PLAYER_CLAMBER_ACCEL_Y*a));this.crouchTimer+=a;this.crouchKey&&this.state==RAPT.PLAYER_STATE_FLOOR||(this.crouchTimer=0);this.state==RAPT.PLAYER_STATE_FLOOR?this.crouchKey?this.velocity.inplaceMul(Math.pow(1E-6,
a)):(this.velocity.y-=RAPT.PLAYER_GRAVITY*a,!this.jumpKey&&this.leftKey!=this.rightKey&&this.onDiagLastTick&&0.99>RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR].segment.normal.y&&(this.velocity=this.velocity.projectOntoAUnitVector(RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR].segment.normal.flip()).mul(0.99),this.velocity.y+=0.001)):this.velocity.y-=RAPT.PLAYER_GRAVITY*a;this.onDiagLastTick=this.state==RAPT.PLAYER_STATE_FLOOR&&0.99>RAPT.gameState.edgeQuad.edges[RAPT.EDGE_FLOOR].segment.normal.y;
this.collideWithOtherPlayer();this.actualVelocity=(new RAPT.Vector).lerp(this.velocity,new RAPT.Vector(this.boost,this.velocity.y),this.boostMagnitude);0!=this.boost&&1<this.velocity.x/this.boost&&(this.actualVelocity.x=this.velocity.x);b=this.actualVelocity.mul(a);this.velocity.x*=Math.pow(7.6E-5,a);b={ref:b};a={ref:this.velocity};c=RAPT.gameState.collider.collideEntityWorld(this,b,a,0,RAPT.gameState.world,!0);b=b.ref;this.velocity=a.ref;this.lastContact=c;this.polygon.moveBy(b);this.actualVelocity.y<
-RAPT.PLAYER_DEATH_SPEED&&null!=c&&0.9<c.normal.y&&(this.setDead(!0),this.onDeath());this.prevState=this.state;this.jumpDisabled=!1},onDeath:function(){this.velocity=new RAPT.Vector(0,0);this.state=RAPT.PLAYER_STATE_AIR;this.boost=this.boostMagnitude=0;this.isSuperJumping=!1;this.timeSinceDeath=0;this.positionOfDeath=this.polygon.center;var a=RAPT.gameState.playerA==this,b=a?1:0.1,a=a?0.1:1;this.sprite.visible(!1);for(var c=500;c--;){var d=(new RAPT.Vector).fromAngle(RAPT.lerp(0,2*Math.PI,Math.random())),
d=this.velocity.add(d.mul(RAPT.lerp(1,10,Math.random())));RAPT.Particle().triangle().position(this.polygon.center).velocity(d).radius(0.01,0.1).bounces(0,4).elasticity(0.05,0.9).decay(0.01,0.02).expand(1,1.2).color(b/2,0.05,a/2,1).mixColor(b,0.1,a,1).fixangle()}RAPT.gameState.incrementStat(RAPT.STAT_PLAYER_DEATHS)},onRespawn:function(){this.sprite.visible(!0)},tickParticles:function(a){if(this.state==RAPT.PLAYER_STATE_LEFT_WALL||this.state==RAPT.PLAYER_STATE_RIGHT_WALL){var b=this.state==RAPT.PLAYER_STATE_RIGHT_WALL?
-1:1,c=this.polygon.getAabb(),d=this.velocity.y;for(this.slideParticleTimer-=a*this.velocity.length();0>this.slideParticleTimer;){this.slideParticleTimer+=RAPT.SLIDE_PARTICLE_TIMER_PERIOD;var e=new RAPT.Vector(this.state==RAPT.PLAYER_STATE_RIGHT_WALL?c.getRight():c.getLeft(),RAPT.lerp(c.getBottom(),c.getTop()+0.25,Math.random())),f=new RAPT.Vector(RAPT.lerp(0,b,Math.random()),RAPT.lerp(d,2*d,Math.random()));RAPT.Particle().color(0.3,0.3,0.3,1).mixColor(0.5,0.3,0.3,1).position(e).circle().radius(0.02,
0.04).decay(0.01,0.2).gravity(15).bounces(2,4).velocity(f).elasticity(0.05,0.1)}}else this.slideParticleTimer=0;if(this.isSuperJumping)for(this.superJumpParticleTimer-=a;0>this.superJumpParticleTimer;)this.superJumpParticleTimer+=RAPT.SUPER_PARTICLE_TIMER_PERIOD,e=this.polygon.center.add(new RAPT.Vector(RAPT.randInRange(-0.2,0.2),RAPT.randInRange(-0.4,0.4))),RAPT.Particle().color(1,1,0,1).mixColor(1,1,0,0.75).position(e).circle().radius(0.03,0.05).expand(1.1,1.2).decay(0.1,0.2).gravity(5).bounces(2,
3);else this.superJumpParticleTimer=0},tickAnimation:function(a){var b=1;this.runningFrame+=a*Math.abs(this.actualVelocity.x)*Math.PI;this.fallingFrame+=8*a;if(this.state==RAPT.PLAYER_STATE_LEFT_WALL)this.facingRight=!1,a=RAPT.wallSlidingKeyframe;else if(this.state==RAPT.PLAYER_STATE_RIGHT_WALL)this.facingRight=!0,a=RAPT.wallSlidingKeyframe;else if(this.state==RAPT.PLAYER_STATE_AIR)0>this.actualVelocity.x?this.facingRight=!1:0<this.actualVelocity.x&&(this.facingRight=!0),this.actualVelocity.y>-RAPT.PLAYER_DEATH_SPEED?
(a=this.actualVelocity.y/4,a=0.5-0.5*(0>a?1/(1-a)-1:1-1/(1+a)),a=RAPT.jumpingKeyframes[0].lerpWith(RAPT.jumpingKeyframes[1],a)):a=(new RAPT.Keyframe).lerp(RAPT.fallingKeyframes,this.fallingFrame);else if(this.state==RAPT.PLAYER_STATE_CLAMBER){var c={},d={};RAPT.gameState.collider.closestToEntityWorld(this,2,c,d,RAPT.gameState.world);a=(this.getCenter().y-d.ref.y)/RAPT.PLAYER_HEIGHT;a+=0.5;a=RAPT.clamberingKeyframes[0].lerpWith(RAPT.clamberingKeyframes[1],a);this.facingRight=c.ref.x<d.ref.x}else this.crouchKey?
a=RAPT.crouchingKeyframe:(a=(new RAPT.Keyframe).lerp(RAPT.runningKeyframes,this.runningFrame),-0.1>this.actualVelocity.x?this.facingRight=!1:0.1<this.actualVelocity.x&&(this.facingRight=!0),b=Math.abs(this.actualVelocity.x)/5,1<b&&(b=1));if(null!=this.sprite){for(c=this.sprite.length-1;c--;)this.sprite.sprite[c].rotation.z=a.angles[c]*b;b=a.center.mul(b);a=this.getCenter();this.sprite.move(a.x+b.x*(this.facingRight?-1:1),a.y+b.y);this.sprite.flip(this.facingRight)}},getInfo:function(){var a=this.getCenter();
this.info[0]=a.x||0;this.info[1]=a.y||0;this.info[2]=this.state;return this.info}};THREE.CustomGeometry=function(a){THREE.BufferGeometry.call(this);this.name=a.name;var b=new THREE.BufferAttribute(new Float32Array(a.p),3),c=new THREE.BufferAttribute(new Float32Array(a.n),3),d=new THREE.BufferAttribute(new Float32Array(a.u),2);this.addIndex(new (65535<b.count?THREE.Uint32Attribute:THREE.Uint16Attribute)(a.i,1));this.addAttribute("position",b);this.addAttribute("normal",c);this.addAttribute("uv",d);this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a.r)};
THREE.CustomGeometry.prototype=Object.create(THREE.BufferGeometry.prototype);THREE.CustomGeometry.prototype.constructor=THREE.CustomGeometry;
RAPT.door0={name:"door0",p:[-0.5,-0.5,0.25,-0.5,-0.5,-0.25,0.5,-0.5,-0.25,0.5,-0.5,-0.25,0.5,-0.5,0.25,-0.5,-0.5,0.25,-0.5,-0.46399998664855957,0.25,0.5,-0.46399998664855957,0.25,0.5,-0.46399998664855957,-0.2499999701976776,0.5,-0.46399998664855957,-0.2499999701976776,-0.5,-0.46399998664855957,-0.2499999701976776,-0.5,-0.46399998664855957,0.25,-0.5,-0.5,0.25,0.5,-0.5,0.25,0.5,-0.46399998664855957,0.25,0.5,-0.46399998664855957,0.25,-0.5,-0.46399998664855957,0.25,-0.5,-0.5,0.25,0.5,-0.5,0.25,0.5,-0.5,
-0.25,0.5,-0.46399998664855957,-0.2499999701976776,0.5,-0.46399998664855957,-0.2499999701976776,0.5,-0.46399998664855957,0.25,0.5,-0.5,0.25,-0.5,-0.5,-0.25,-0.5,-0.5,0.25,-0.5,-0.46399998664855957,0.25,-0.5,-0.46399998664855957,0.25,-0.5,-0.46399998664855957,-0.2499999701976776,-0.5,-0.5,-0.25],n:[0,-1,-0,0,-1,-0,0,-1,-0,0,-1,-0,0,-1,-0,0,-1,-0,0,1,-0,0,1,-0,0,1,-0,0,1,-0,0,1,-0,0,1,-0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,-0,1,0,-0,1,0,-0,1,0,-0,1,0,-0,1,0,-0,-1,0,-0,-1,0,-0,-1,0,-0,-1,0,-0,-1,
0,-0,-1,0,-0],u:[0.013511396013200283,0.8359469175338745,0.013511396013200283,0.9502769708633423,0.24217157065868378,0.9502769708633423,0.24217157065868378,0.9502769708633423,0.24217157065868378,0.8359469175338745,0.013511396013200283,0.8359469175338745,0.013511396013200283,0.8165258765220642,0.24217157065868378,0.8165258765220642,0.24217157065868378,0.7021958827972412,0.24217157065868378,0.7021958827972412,0.013511396013200283,0.7021958827972412,0.013511396013200283,0.8165258765220642,0.013511396013200283,
0.8359469175338745,0.24217157065868378,0.8359469175338745,0.24217157065868378,0.8165258765220642,0.24217157065868378,0.8165258765220642,0.013511396013200283,0.8165258765220642,0.013511396013200283,0.8359469175338745,0.007494611665606499,0.9820325374603271,0.12384999543428421,0.9820325374603271,0.12384999543428421,0.9632607698440552,0.12384999543428421,0.9632607698440552,0.0074946265667676926,0.9632607698440552,0.007494611665606499,0.9820325374603271,0.12778574228286743,0.9820325374603271,0.2441411167383194,
0.9820325374603271,0.2441411167383194,0.9632607698440552,0.2441411167383194,0.9632607698440552,0.12778574228286743,0.9632607698440552,0.12778574228286743,0.9820325374603271],i:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],r:0.5593067139238773};
RAPT.door2={name:"door2",p:[-0.4999999403953552,0.4999999403953552,0.24999985098838806,-0.49999964237213135,0.49999991059303284,-0.25000011920928955,0.49999991059303284,-0.4999999403953552,-0.25,0.49999991059303284,-0.4999999403953552,-0.25,0.4999997913837433,-0.4999998211860657,0.2500000298023224,-0.4999999403953552,0.4999999403953552,0.24999985098838806,-0.4499995708465576,0.4999997913837433,-0.25000011920928955,-0.4499998986721039,0.4999999403953552,0.24999988079071045,0.4999997913837433,-0.4499998688697815,
0.2500000298023224,0.4999997913837433,-0.4499998688697815,0.2500000298023224,0.4999999701976776,-0.4499998092651367,-0.2500000298023224,-0.4499995708465576,0.4999997913837433,-0.25000011920928955,0.4999997913837433,-0.4499998688697815,0.2500000298023224,-0.4499998986721039,0.4999999403953552,0.24999988079071045,-0.4999999403953552,0.4999999403953552,0.24999985098838806,-0.4999999403953552,0.4999999403953552,0.24999985098838806,0.4999997913837433,-0.4999998211860657,0.2500000298023224,0.4999997913837433,
-0.4499998688697815,0.2500000298023224,0.4999999701976776,-0.4499998092651367,-0.2500000298023224,0.4999997913837433,-0.4499998688697815,0.2500000298023224,0.4999997913837433,-0.4999998211860657,0.2500000298023224,0.4999997913837433,-0.4999998211860657,0.2500000298023224,0.49999991059303284,-0.4999999403953552,-0.25,0.4999999701976776,-0.4499998092651367,-0.2500000298023224,-0.4999999403953552,0.4999999403953552,0.24999985098838806,-0.4499998986721039,0.4999999403953552,0.24999988079071045,-0.4499995708465576,
0.4999997913837433,-0.25000011920928955,-0.4499995708465576,0.4999997913837433,-0.25000011920928955,-0.49999964237213135,0.49999991059303284,-0.25000011920928955,-0.4999999403953552,0.4999999403953552,0.24999985098838806],n:[-0.70710688829422,-0.7071066498756409,-2.9725663353019627E-7,-0.7071069478988647,-0.7071066498756409,-3.793217615566391E-7,-0.7071067690849304,-0.7071067690849304,-8.206513513187019E-8,-0.7071067690849304,-0.7071067690849304,-8.206513513187019E-8,-0.7071067690849304,-0.7071067690849304,
-0,-0.70710688829422,-0.7071066498756409,-2.9725663353019627E-7,0.7071068286895752,0.7071067094802856,2.7200016461392806E-7,0.7071068286895752,0.7071067094802856,2.5288113647548016E-7,0.7071067690849304,0.7071067690849304,3.180556973347848E-7,0.7071067690849304,0.7071067690849304,3.180556973347848E-7,0.7071067690849304,0.7071067690849304,3.371747538949421E-7,0.7071068286895752,0.7071067094802856,2.7200016461392806E-7,-1.8335327922613942E-7,-4.77820316646671E-9,1,-5.960459361631365E-7,-4.391914956158871E-7,
1,-5.824268782816944E-7,-4.248556422226102E-7,1,-5.824268782816944E-7,-4.248556422226102E-7,1,-1.7881397695873602E-7,0,1,-1.8335327922613942E-7,-4.77820316646671E-9,1,1,-1.1164499937876826E-6,2.459828181144985E-7,1,0,3.576278118089249E-7,1,-7.563970427781896E-8,3.500638570130832E-7,1,-7.563970427781896E-8,3.500638570130832E-7,1,-1.192089825963194E-6,2.384188633186568E-7,1,-1.1164499937876826E-6,2.459828181144985E-7,1.512797638270058E-7,1,-2.828951437550131E-7,1.7763552130969917E-13,1,-2.980232238769531E-7,
2.2329027160594705E-6,1,-7.473130381185911E-8,2.2329027160594705E-6,1,-7.473130381185911E-8,2.3841823804104934E-6,1,-5.9603227242632784E-8,1.512797638270058E-7,1,-2.828951437550131E-7],u:[0.25677812099456787,0.8359021544456482,0.25677818059921265,0.9514144062995911,0.6215648055076599,0.9514145255088806,0.6215648055076599,0.9514145255088806,0.6215648055076599,0.835902214050293,0.25677812099456787,0.8359021544456482,0.2658978998661041,0.7010469436645508,0.2658977806568146,0.8163527250289917,0.612445056438446,
0.8163527250289917,0.612445056438446,0.8163527250289917,0.612445056438446,0.7010469436645508,0.2658978998661041,0.7010469436645508,0.612445056438446,0.8163527250289917,0.2658977806568146,0.8163527250289917,0.25677812099456787,0.8359021544456482,0.25677812099456787,0.8359021544456482,0.6215648055076599,0.835902214050293,0.612445056438446,0.8163527250289917,0.4172526001930237,0.9611241817474365,0.26853132247924805,0.9611241817474365,0.26853132247924805,0.9804660677909851,0.26853132247924805,0.9804660677909851,
0.4172526001930237,0.9804660677909851,0.4172526001930237,0.9611241817474365,0.6067237854003906,0.9804660677909851,0.6067237854003906,0.9611241817474365,0.4338368773460388,0.9611241817474365,0.4338368773460388,0.9611241817474365,0.4338368773460388,0.9804660677909851,0.6067237854003906,0.9804660677909851],i:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],r:0.7499998956918753};
RAPT.door1={name:"door1",p:[0.4999997019767761,0.49999988079071045,-0.2500000596046448,0.49999964237213135,0.4999998211860657,0.24999988079071045,-0.4999999403953552,-0.4999999403953552,0.24999991059303284,-0.4999999403953552,-0.4999999403953552,0.24999991059303284,-0.4999999403953552,-0.49999988079071045,-0.25000011920928955,0.4999997019767761,0.49999988079071045,-0.2500000596046448,0.4499995708465576,0.4999997019767761,0.24999988079071045,0.44999969005584717,0.49999988079071045,-0.2500000596046448,
-0.4999999403953552,-0.44999992847442627,-0.25000011920928955,-0.4999999403953552,-0.44999992847442627,-0.25000011920928955,-0.4999999403953552,-0.4499998688697815,0.24999991059303284,0.4499995708465576,0.4999997019767761,0.24999988079071045,-0.4999999403953552,-0.4499998688697815,0.24999991059303284,-0.4999999403953552,-0.44999992847442627,-0.25000011920928955,-0.4999999403953552,-0.49999988079071045,-0.25000011920928955,-0.4999999403953552,-0.49999988079071045,-0.25000011920928955,-0.4999999403953552,
-0.4999999403953552,0.24999991059303284,-0.4999999403953552,-0.4499998688697815,0.24999991059303284,-0.4999999403953552,-0.4499998688697815,0.24999991059303284,-0.4999999403953552,-0.4999999403953552,0.24999991059303284,0.49999964237213135,0.4999998211860657,0.24999988079071045,0.49999964237213135,0.4999998211860657,0.24999988079071045,0.4499995708465576,0.4999997019767761,0.24999988079071045,-0.4999999403953552,-0.4499998688697815,0.24999991059303284,0.4999997019767761,0.49999988079071045,-0.2500000596046448,
0.44999969005584717,0.49999988079071045,-0.2500000596046448,0.4499995708465576,0.4999997019767761,0.24999988079071045,0.4499995708465576,0.4999997019767761,0.24999988079071045,0.49999964237213135,0.4999998211860657,0.24999988079071045,0.4999997019767761,0.49999988079071045,-0.2500000596046448],n:[0.7071068286895752,-0.7071067690849304,-1.8236685050965207E-8,0.7071068286895752,-0.7071067690849304,1.5072895392215756E-14,0.7071068286895752,-0.7071067690849304,-6.605700519912716E-8,0.7071068286895752,
-0.7071067690849304,-6.605700519912716E-8,0.7071068286895752,-0.7071067690849304,-8.429369557916289E-8,0.7071068286895752,-0.7071067690849304,-1.8236685050965207E-8,-0.7071068286895752,0.7071067094802856,4.605555403713879E-8,-0.70710688829422,0.7071066498756409,8.429367426288081E-8,-0.7071068286895752,0.7071067690849304,-4.6055575353420863E-8,-0.7071068286895752,0.7071067690849304,-4.6055575353420863E-8,-0.7071068286895752,0.7071067690849304,-8.429369557916289E-8,-0.7071068286895752,0.7071067094802856,
4.605555403713879E-8,-1,0,-0,-1,0,-0,-1,0,-0,-1,0,-0,-1,0,-0,-1,0,-0,2.947804311759228E-8,3.4136285465002913E-10,1,2.980233659855003E-8,0,1,9.728094996219738E-10,3.034686457681346E-8,1,9.728094996219738E-10,3.034686457681346E-8,1,-7.479407311593647E-14,3.13709520582961E-8,1,2.947804311759228E-8,3.4136285465002913E-10,1,-1.5127962171845866E-7,1,3.424999306389509E-7,0,1,3.576279254957626E-7,-2.232902943433146E-6,1,1.343370286122081E-7,-2.232902943433146E-6,1,1.343370286122081E-7,-2.3841828351578442E-6,
1,1.1920903375539638E-7,-1.5127962171845866E-7,1,3.424999306389509E-7],u:[0.9945561289787292,0.9516163468360901,0.9945560097694397,0.8358394503593445,0.6344934105873108,0.8358395099639893,0.6344934105873108,0.8358395099639893,0.6344934105873108,0.9516164064407349,0.9945561289787292,0.9516163468360901,0.983639657497406,0.8165688514709473,0.983639657497406,0.7005841732025146,0.6454096436500549,0.7005842924118042,0.6454096436500549,0.7005842924118042,0.6454096436500549,0.8165689706802368,0.983639657497406,
0.8165688514709473,0.9876566529273987,0.9607643485069275,0.8211650252342224,0.9607643485069275,0.8211650252342224,0.9802371859550476,0.8211650252342224,0.9802371859550476,0.9876566529273987,0.9802371859550476,0.9876566529273987,0.9607643485069275,0.6454096436500549,0.8165689706802368,0.6344934105873108,0.8358395099639893,0.9945560097694397,0.8358394503593445,0.9945560097694397,0.8358394503593445,0.983639657497406,0.8165688514709473,0.6454096436500549,0.8165689706802368,0.6357163786888123,0.9607643485069275,
0.6357163786888123,0.9802371859550476,0.8022080063819885,0.9802371859550476,0.8022080063819885,0.9802371859550476,0.8022080063819885,0.9607643485069275,0.6357163786888123,0.9607643485069275],i:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],r:0.7499998261531261};RAPT.W3D=null;RAPT.MAT_PLAYER=null;RAPT.GEO={};var debug=debug||null;
RAPT.World3D=function(a){RAPT.GEO[RAPT.door0.name]=new THREE.CustomGeometry(RAPT.door0);RAPT.GEO[RAPT.door1.name]=new THREE.CustomGeometry(RAPT.door1);RAPT.GEO[RAPT.door2.name]=new THREE.CustomGeometry(RAPT.door2);this.isMobile=!1;this.antialias=!0;var b=navigator.userAgent;if(b.match(/Android/i)||b.match(/webOS/i)||b.match(/iPhone/i)||b.match(/iPad/i)||b.match(/iPod/i)||b.match(/BlackBerry/i)||b.match(/Windows Phone/i))this.isMobile=!0,this.antialias=!1;this.debug=document.getElementById("debug");
this.vs={w:window.innerWidth,h:window.innerHeight,r:0.0084,mw:0,mh:0,d:10,fov:60};this.is2D=this.split=!1;this.camera=[];this.initCameras();this.scene=new THREE.Scene;RAPT.GEO.front=this.plane("front");RAPT.GEO.back=this.plane("back");RAPT.GEO.floor=this.plane("floor",-Math.PI/2,-0.5,!1,0,0.5);RAPT.GEO.dfloor=this.plane("floor",-Math.PI/2,0,!0,Math.PI/4,0.5);b=[];b[0]=THREE.ImageUtils.loadTexture("textures/level.png");b[1]=THREE.ImageUtils.loadTexture("textures/particle.png");b[2]=THREE.ImageUtils.loadTexture("textures/player.png");
b[3]=THREE.ImageUtils.loadTexture("textures/enemy.png");b[4]=THREE.ImageUtils.loadTexture("textures/level.png");b[4].flipY=!1;for(var c=b.length;c--;);RAPT.MAT_LEVEL=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[0],transparent:!0}));RAPT.MAT_DOOR_R=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[4],color:16711680,transparent:!0}));RAPT.MAT_DOOR_B=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[4],color:26367,transparent:!0}));RAPT.MAT_DOOR=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[4],
color:16777215,transparent:!0}));RAPT.MAT_PLAYER=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[2],transparent:!0,side:THREE.DoubleSide,alphaTest:0.1}));RAPT.MAT_ENEMY=new THREE.ShaderMaterial(RAPT.MakeBasicShader({map:b[3],transparent:!0,side:THREE.DoubleSide,alphaTest:0.1}));RAPT.Particle.init3d(this.scene,b[1]);this.doors=[];this.sprites=[];this.renderer=new THREE.WebGLRenderer({precision:"mediump",canvas:a,antialias:this.antialias,alpha:!1});this.renderer.setPixelRatio(window.devicePixelRatio);
this.renderer.setSize(this.vs.w,this.vs.h);this.renderer.setClearColor(7566195,1);this.effect=new RAPT.SplitEffect(this.renderer);this.effect.setSize(this.vs.w,this.vs.h);RAPT.W3D=this;a.onmousewheel=function(a){RAPT.W3D.onMouseWheel(a)}};
RAPT.World3D.prototype={constructor:RAPT.World3D,render:function(){RAPT.Particle.update();this.split?this.effect.render(this.scene,this.camera[1],this.camera[2]):this.renderer.render(this.scene,this.camera[0])},addDoor:function(a){this.scene.add(a);this.doors.push(a)},clearAllDoor:function(){for(var a=this.doors.length;a--;)this.scene.remove(this.doors[a])},initCameras:function(){if(this.is2D)this.camera[0]=new THREE.OrthographicCamera(-this.vs.w*this.vs.r,this.vs.w*this.vs.r,this.vs.h*this.vs.r,
-this.vs.h*this.vs.r,0.1,100),this.camera[1]=new THREE.OrthographicCamera(-this.vs.w*this.vs.r,this.vs.w*this.vs.r,this.vs.h*this.vs.r,-this.vs.h*this.vs.r,0.1,100),this.camera[2]=new THREE.OrthographicCamera(-this.vs.w*this.vs.r,this.vs.w*this.vs.r,this.vs.h*this.vs.r,-this.vs.h*this.vs.r,0.1,100);else{var a=this.vs.w/this.vs.h,b=this.vs.fov;this.camera[0]=new THREE.PerspectiveCamera(b,a,0.1,100);this.camera[1]=new THREE.PerspectiveCamera(b,a,0.1,100);this.camera[2]=new THREE.PerspectiveCamera(b,
a,0.1,100)}},onMouseWheel:function(a){var b=0;a.wheelDeltaY?b=0.01*a.wheelDeltaY:a.wheelDelta?b=0.05*a.wheelDelta:a.detail&&(b=1*-a.detail);this.vs.r-=0.001*b;0.001>this.vs.r&&(this.vs.r=0.001);this.vs.d-=b/6;Math.tan(Math.PI/360*this.vs.fov);Math.tan(this.vs.fov/2/180*Math.PI);(RAPT.gameScale+b/3).toFixed(0);this.camera[0].position.z=this.vs.d;this.camera[1].position.z=this.vs.d;this.camera[2].position.z=this.vs.d;a.preventDefault();a.stopPropagation()},plane:function(a,b,c,d,e,f){f||(f=1);d=d?new THREE.PlaneBufferGeometry(Math.sqrt(Math.pow(1,
2)+Math.pow(1,2)),f):new THREE.PlaneBufferGeometry(1,f);d.rotateX(b||0);d.rotateZ(e||0);d.translate(0,c||0,0);"front"==a&&this.changeuv(d,1,0,8);"back"==a&&this.changeuv(d,1,2,8);"floor"==a&&this.changeuv(d,1,4,8);return(new THREE.Geometry).fromBufferGeometry(d)},triangle:function(a){var b=new THREE.Geometry;a?(a=this.changeuv(null,1,2,8),b.vertices.push(new THREE.Vector3(-0.5,-0.5,-0.25)),b.vertices.push(new THREE.Vector3(0.5,0.5,-0.25)),b.vertices.push(new THREE.Vector3(-0.5,0.5,-0.25)),b.faces.push(new THREE.Face3(0,
1,2)),b.faceVertexUvs[0].push([new THREE.Vector2(a[0],a[1]),new THREE.Vector2(a[2],a[3]),new THREE.Vector2(a[4],a[5])])):(a=this.changeuv(null,1,0,8),b.vertices.push(new THREE.Vector3(0.5,0.5,0.25)),b.vertices.push(new THREE.Vector3(-0.5,-0.5,0.25)),b.vertices.push(new THREE.Vector3(0.5,-0.5,0.25)),b.faces.push(new THREE.Face3(0,1,2)),b.faceVertexUvs[0].push([new THREE.Vector2(a[2],a[3]),new THREE.Vector2(a[4],a[5]),new THREE.Vector2(a[6],a[7])]));b.computeFaceNormals();return b},changeuv:function(a,
b,c,d){d=1/d;b*=d;c=1-c*d;c=[b,c,b+d,c-d];c=new Float32Array([c[0],c[1],c[2],c[1],c[0],c[3],c[2],c[3]]);if(a)a.attributes.uv.array=c;else return c},clearLevel:function(){this.removeAll();this.clearAllDoor();this.edgemesh&&(this.scene.remove(this.edgemesh),this.edgemesh.geometry.dispose())},initLevel:function(a){this.clearLevel();var b=new THREE.Geometry,c=new THREE.Matrix4,d=new THREE.Matrix4,e,f,g,h,k,l=a.cells.length,m=a.cells[0].length;for(e=0;e<l;e++)for(f=0;f<m;f++)if(g=a.getCellType(e,f),h=
a.getEdges(e,f),0===g?(c.makeTranslation(e+0.5,f+0.5,-0.25),b.merge(RAPT.GEO.back,c)):1===g&&(c.makeTranslation(e+0.5,f+0.5,0.25),a.getCellNE(e,f)&&b.merge(RAPT.GEO.front,c)),h.length)for(g=h.length;g--;)if(c.makeTranslation(e+0.5,f+0.5,0),k=h[g].type,4>k){d.makeRotationZ(0);switch(k){case 1:d.makeRotationZ(-RAPT.PI90);break;case 0:d.makeRotationZ(RAPT.PI90);break;case 3:d.makeRotationZ(RAPT.PI);break;case 2:d.makeRotationZ(0)}c.multiply(d);b.merge(RAPT.GEO.floor,c)}else{switch(k){case 7:d.makeRotationZ(RAPT.PI90);
break;case 5:d.makeRotationZ(-RAPT.PI90);break;case 6:d.makeRotationZ(RAPT.PI);break;case 4:d.makeRotationZ(0)}c.multiply(d);b.merge(RAPT.GEO.dfloor,c);b.merge(this.triangle(),c);b.merge(this.triangle(!0),c)}b.mergeVertices();a=(new THREE.BufferGeometry).fromGeometry(b);a.computeBoundingSphere();this.edgemesh=new THREE.Mesh(a,RAPT.MAT_LEVEL);this.scene.add(this.edgemesh)},tell:function(a){null!==debug&&(debug.innerHTML=a)},upCamera:function(a,b,c){this.camera[c].position.set(a,b,this.vs.d)},resize:function(){this.vs.w=
window.innerWidth;this.vs.h=window.innerHeight;this.vs.mw=0.5*this.vs.w;this.vs.mh=0.5*this.vs.h;this.updateCamera();this.split?this.effect.setSize(this.vs.w,this.vs.h):this.renderer.setSize(this.vs.w,this.vs.h)},updateCamera:function(){for(var a=this.vs.w/this.vs.h,b=this.camera.length,c;b--;)c=this.camera[b],this.is2D?(c.left=-this.vs.w*this.vs.r,c.right=this.vs.w*this.vs.r,c.top=this.vs.h*this.vs.r,c.bottom=-this.vs.h*this.vs.r):c.aspect=a,c.updateProjectionMatrix()},setSplit:function(a){a!==this.split&&
(this.split=a,this.resize())},add:function(a){this.sprites.push(a);this.scene.add(a.group)},remove:function(a){this.sprites.splice(this.sprites.indexOf(a),1);this.scene.remove(a.group);a.clear()},removeAll:function(){for(var a=this.sprites.length;a--;)this.remove(this.sprites[a])}};
RAPT.SplitEffect=function(a,b,c){var d=new THREE.OrthographicCamera(-1,1,1,-1,0,1),e={minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat};void 0===b&&(b=512);void 0===c&&(c=512);var f=new THREE.WebGLRenderTarget(b,c,e),g=new THREE.WebGLRenderTarget(b,c,e),h=new THREE.ShaderMaterial({uniforms:{sourceA:{type:"t",value:f},sourceB:{type:"t",value:g},split:{type:"f",value:0.5},angle:{type:"f",value:0},fuzzy:{type:"f",value:0},blendGamma:{type:"f",value:2.2}},vertexShader:"precision mediump float;\nuniform float angle;\nvarying float c;\nvarying float s;\nvarying float t;\nvarying vec2 vUv;\nvoid main() {\n   c = cos(angle);\n   s = sin(angle);\n   t = abs(c + s);\n   vUv = vec2( uv.x, uv.y );\n   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",
fragmentShader:"precision mediump float;\nuniform sampler2D sourceA;\nuniform sampler2D sourceB;\nuniform float split;\nuniform float angle;\nuniform float fuzzy;\nuniform float blendGamma;\nvarying vec2 vUv;\nvarying float c;\nvarying float s;\nvarying float t;\nvec4 textureLookup(sampler2D tex, vec2 texCoord, vec3 exp) {\n   if (any(lessThan(texCoord, vec2(0.0))) || any(greaterThan(texCoord, vec2(1.0)))) {\n       return vec4(0.0);\n   } else {\n       vec4 pixel = texture2D(tex, texCoord);\n       pixel.rgb = pow(abs(pixel.rgb), exp);\n       return pixel;\n   }\n}\nvoid main() {\n   vec4 colorL, colorR;\n   vec2 uv = vUv;\n   vec3 exp = vec3(blendGamma);\n   vec4 pixel1 = textureLookup(sourceA, uv, exp);\n   vec4 pixel2 = textureLookup(sourceB, uv, exp);\n   float mn = (split - fuzzy * (1.0 - split));\n   float mx = (split + fuzzy * split);\n   vec2 coords = uv - vec2(0.5);\n   coords = vec2(coords.x * c - coords.y * s, coords.x * s + coords.y * c);\n   float scale = max(abs(c - s), abs(s + c));\n   coords /= scale;\n   coords += vec2(0.5);\n   float x = coords.x;\n   gl_FragColor = mix(pixel2, pixel1, smoothstep(mn, mx, x));\n   gl_FragColor.rgb = pow(abs(gl_FragColor.rgb), 1.0 / exp);\n}"}),
k=new THREE.Scene;k.add(new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),h));this.setAngle=function(a){h.uniforms.angle.value=a};this.setFuzzy=function(a){h.uniforms.fuzzy.value=a};this.setSize=function(b,c){f&&f.dispose();g&&g.dispose();f=new THREE.WebGLRenderTarget(b,c,e);g=new THREE.WebGLRenderTarget(b,c,e);h.uniforms.sourceA.value=f;h.uniforms.sourceB.value=g;a.setSize(b,c)};this.render=function(b,c,e){a.render(b,c,f,!0);a.render(b,e,g,!0);a.render(k,d)};this.dispose=function(){f&&f.dispose();
g&&g.dispose()}};RAPT.ROCKET_SPEED=2.5;RAPT.ROCKET_MAX_ROTATION=8;RAPT.ROCKET_RADIUS=0.15;RAPT.ROCKET_ELASTICITY=1;RAPT.ROCKET_HEADING_CONSTRAINT_TIME=0.3;RAPT.PARTICLE_FREQUENCY=0.03;RAPT.drawRocket=function(a){a.strokeStyle="black";a.beginPath();a.moveTo(-RAPT.ROCKET_RADIUS,0.075);a.lineTo(RAPT.ROCKET_RADIUS-0.075,0.075);a.lineTo(RAPT.ROCKET_RADIUS,0);a.lineTo(RAPT.ROCKET_RADIUS-0.075,-0.075);a.lineTo(-RAPT.ROCKET_RADIUS,-0.075);a.closePath();a.fill();a.stroke()};
RAPT.Rocket=function(a,b,c,d,e){RAPT.RotatingEnemy.call(this,e,a,RAPT.ROCKET_RADIUS,c,RAPT.ROCKET_ELASTICITY);this.target=b;this.maxRotation=d;this.timeUntilFree=RAPT.ROCKET_HEADING_CONSTRAINT_TIME;this.timeUntilNextParticle=0;this.velocity=new RAPT.Vector(RAPT.ROCKET_SPEED*Math.cos(c),RAPT.ROCKET_SPEED*Math.sin(c));this.sprite=new RAPT.SpriteGroup({name:"roket",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[this.target.color,0]],list:["p1"],sizes:[[0.7,0.7]]});this.sprite.moveto(a)};
RAPT.Rocket.prototype=Object.create(RAPT.RotatingEnemy.prototype);RAPT.Rocket.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};RAPT.Rocket.prototype.setTarget=function(a){this.target=a};RAPT.Rocket.prototype.calcHeading=function(a){if(!this.target.isDead()){var b=this.target.getCenter().sub(this.getCenter()).atan2();this.heading=RAPT.adjustAngleToTarget(this.heading,b,this.maxRotation*a)}};
RAPT.Rocket.prototype.move=function(a){0>=this.timeUntilFree?(this.calcHeading(a),this.velocity=new RAPT.Vector(RAPT.ROCKET_SPEED*Math.cos(this.heading),RAPT.ROCKET_SPEED*Math.sin(this.heading))):this.timeUntilFree-=a;return this.velocity.mul(a)};
RAPT.Rocket.prototype.afterTick=function(a){var b=this.getCenter();this.sprite.moveto(b);this.sprite.group.rotation.z=this.heading;b=b.sub(this.velocity.unit().mul(RAPT.ROCKET_RADIUS));for(this.timeUntilNextParticle-=a;0>=this.timeUntilNextParticle&&!this.isDead();)a=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),a=a.mul(RAPT.randInRange(0,2)).sub(this.velocity.mul(3)),RAPT.Particle().position(b).velocity(a).radius(0.1,0.15).bounces(1).decay(1E-6,1E-5).expand(1,1.2).color(1,0.5,0,1).mixColor(1,
1,0,1).triangle(),a=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),a=a.mul(RAPT.randInRange(0.25,1)).sub(this.velocity),RAPT.Particle().position(b).velocity(a).radius(0.05,0.1).bounces(1).elasticity(0.05,0.9).decay(5E-4,0.001).expand(1.2,1.4).color(0,0,0,0.25).mixColor(0.25,0.25,0.25,0.75).circle().gravity(-0.4,0),this.timeUntilNextParticle+=RAPT.PARTICLE_FREQUENCY};RAPT.Rocket.prototype.reactToWorld=function(a){this.setDead(!0)};
RAPT.Rocket.prototype.reactToPlayer=function(a){this.setDead(!0);a.setDead(!0)};RAPT.Rocket.prototype.onDeath=function(){var a=this.getCenter();this.sprite.remove();for(var b=0;50>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=c.mul(RAPT.randInRange(0.5,17));RAPT.Particle().position(a).velocity(c).radius(0.02,0.15).bounces(0,4).elasticity(0.05,0.9).decay(1E-5,1E-4).expand(1,1.2).color(1,0.5,0,1).mixColor(1,1,0,1).triangle()}};RAPT.Rocket.prototype.draw=function(a){};RAPT.BOMB_RADIUS=0.15;RAPT.Bomb=function(a,b){RAPT.FreefallEnemy.call(this,RAPT.ENEMY_BOMB,a,RAPT.BOMB_RADIUS,0);this.velocity=b;this.sprite=new RAPT.SpriteGroup({name:"bombe",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[6,0]],list:["bombe"]});this.sprite.moveto(a)};RAPT.Bomb.prototype=Object.create(RAPT.FreefallEnemy.prototype);RAPT.Bomb.prototype.afterTick=function(a){this.sprite.moveto(this.hitCircle.center)};
RAPT.Bomb.prototype.onDeath=function(){this.sprite.remove();for(var a=this.getShape().getCenter(),b=0;50>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)).mul(RAPT.randInRange(0.5,7));RAPT.Particle().position(a).velocity(c).radius(0.02,0.15).bounces(0,4).elasticity(0.05,0.9).decay(1E-5,1E-4).expand(1,1.2).color(1,0.5,0,1).mixColor(1,1,0,1).triangle().fixangle()}RAPT.Particle().position(a).radius(0.1).bounces(0).gravity(!1).decay(1E-6).expand(10).color(1,1,1,5).circle()};RAPT.BOMBER_WIDTH=0.4;RAPT.BOMBER_HEIGHT=0.4;RAPT.BOMBER_SPEED=2;RAPT.BOMB_FREQUENCY=1;RAPT.BOMBER_ELASTICITY=1;RAPT.BOMBER_EXPLOSION_POWER=6;
RAPT.Bomber=function(a,b){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_BOMBER,a,RAPT.BOMBER_WIDTH,RAPT.BOMBER_HEIGHT,RAPT.BOMBER_ELASTICITY,RAPT.BOMB_FREQUENCY,RAPT.randInRange(0,RAPT.BOMB_FREQUENCY));b<0.25*Math.PI?this.setVelocity(new RAPT.Vector(RAPT.BOMBER_SPEED,0)):b<0.75*Math.PI?this.setVelocity(new RAPT.Vector(0,RAPT.BOMBER_SPEED)):b<1.25*Math.PI?this.setVelocity(new RAPT.Vector(-RAPT.BOMBER_SPEED,0)):b<1.75*Math.PI?this.setVelocity(new RAPT.Vector(0,-RAPT.BOMBER_SPEED)):this.setVelocity(new RAPT.Vector(RAPT.BOMBER_SPEED,
0));this.sprite=new RAPT.SpriteGroup({name:"bomber",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[5,0],[6,0]],list:["body","bombe1"]});this.sprite.moveto(a);this.startPosY=a.y};RAPT.Bomber.prototype=Object.create(RAPT.SpawningEnemy.prototype);RAPT.Bomber.prototype.move=function(a){return this.velocity.mul(a)};
RAPT.Bomber.prototype.reactToPlayer=function(a){a.getCenter().sub(this.getCenter()).y>RAPT.BOMBER_HEIGHT-0.05?(a.setVelocity(new RAPT.Vector(a.getVelocity().x,RAPT.BOMBER_EXPLOSION_POWER)),this.setDead(!0)):a.isSuperJumping?this.setDead(!0):a.setDead(!0)};RAPT.Bomber.prototype.spawn=function(){var a=new RAPT.Vector(this.hitBox.lowerLeft.x+0.5*this.hitBox.getWidth(),this.hitBox.getBottom());RAPT.gameState.addEnemy(new RAPT.Bomb(a,new RAPT.Vector(0,Math.min(this.velocity.y,-0.3))),a);return!0};
RAPT.Bomber.prototype.afterTick=function(){var a=this.getCenter();this.sprite.moveto(a);a=1*this.getReloadPercentage();this.sprite.sprite[1].scale.set(a,a,a)};RAPT.Bomber.prototype.onDeath=function(){this.sprite.remove();RAPT.Bomb.prototype.onDeath.call(this);RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS)};RAPT.BOUNCY_ROCKET_SPEED=4;RAPT.BOUNCY_ROCKET_MAX_ROTATION=3;RAPT.BOUNCY_ROCKET_HEALTH=2;
RAPT.BouncyRocket=function(a,b,c,d){RAPT.Rocket.call(this,a,b,c,RAPT.BOUNCY_ROCKET_MAX_ROTATION,RAPT.ENEMY_BOUNCY_ROCKET);this.velocity=new RAPT.Vector(RAPT.BOUNCY_ROCKET_SPEED*Math.cos(c),RAPT.BOUNCY_ROCKET_SPEED*Math.sin(c));this.launcher=d;this.hitsUntilExplodes=RAPT.BOUNCY_ROCKET_HEALTH;this.sprite&&this.sprite.remove();this.sprite=new RAPT.SpriteGroup({name:"bouncyrocket",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[this.target.color+5,1]],list:["p1"]});this.sprite.moveto(a)};
RAPT.BouncyRocket.prototype=Object.create(RAPT.Rocket.prototype);RAPT.BouncyRocket.prototype.move=function(a){this.heading=this.velocity.atan2();this.calcHeading(a);this.velocity=new RAPT.Vector(RAPT.BOUNCY_ROCKET_SPEED*Math.cos(this.heading),RAPT.BOUNCY_ROCKET_SPEED*Math.sin(this.heading));return this.velocity.mul(a)};RAPT.BouncyRocket.prototype.reactToWorld=function(a){--this.hitsUntilExplodes;0>=this.hitsUntilExplodes?this.setDead(!0):this.target=RAPT.gameState.getOtherPlayer(this.target)};
RAPT.BouncyRocket.prototype.setDead=function(a){this.sprite.remove();RAPT.Enemy.prototype.setDead.call(this,a);a&&null!==this.launcher&&this.launcher.rocketDestroyed()};RAPT.BOUNCY_LAUNCHER_WIDTH=0.5;RAPT.BOUNCY_LAUNCHER_HEIGHT=0.5;RAPT.BOUNCY_LAUNCHER_SHOOT_FREQ=1;RAPT.BOUNCY_LAUNCHER_RANGE=8;
RAPT.BouncyRocketLauncher=function(a,b){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_BOUNCY_ROCKET_LAUNCHER,a,RAPT.BOUNCY_LAUNCHER_WIDTH,RAPT.BOUNCY_LAUNCHER_HEIGHT,0,RAPT.BOUNCY_LAUNCHER_SHOOT_FREQ,0);this.target=b;this.canFire=!0;this.angle=0;this.sprite=new RAPT.SpriteGroup({name:"bouncyrocketlaunch",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[this.target.color+7,1]],list:["p1"]});this.sprite.moveto(a)};RAPT.BouncyRocketLauncher.prototype=Object.create(RAPT.SpawningEnemy.prototype);
RAPT.BouncyRocketLauncher.prototype.setTarget=function(a){this.target=a};RAPT.BouncyRocketLauncher.prototype.canCollide=function(){return!1};RAPT.BouncyRocketLauncher.prototype.rocketDestroyed=function(){this.canFire=!0};RAPT.BouncyRocketLauncher.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};
RAPT.BouncyRocketLauncher.prototype.spawn=function(){if(this.canFire&&!this.target.isDead()){var a=this.target.getCenter().sub(this.getCenter());if(a.length()<RAPT.BOUNCY_LAUNCHER_RANGE&&!RAPT.gameState.collider.lineOfSightWorld(this.getCenter(),this.target.getCenter(),RAPT.gameState.world))return RAPT.gameState.addEnemy(new RAPT.BouncyRocket(this.getCenter(),this.target,a.atan2(),this),this.getCenter()),this.canFire=!1,!0}return!1};
RAPT.BouncyRocketLauncher.prototype.afterTick=function(a){a=this.getCenter();this.target.isDead()||(this.sprite.group.rotation.z=a.sub(this.target.getCenter()).atan2()+RAPT.PI);this.sprite.moveto(a)};RAPT.CORROSION_CLOUD_RADIUS=0.5;RAPT.CORROSION_CLOUD_SPEED=0.7;RAPT.CORROSION_CLOUD_ACCEL=10;RAPT.CorrosionCloud=function(a,b){RAPT.RotatingEnemy.call(this,RAPT.ENEMY_CLOUD,a,RAPT.CORROSION_CLOUD_RADIUS,0,0);this.target=b;this.smoothedVelocity=new RAPT.Vector(0,0)};RAPT.CorrosionCloud.prototype=Object.create(RAPT.RotatingEnemy.prototype);RAPT.CorrosionCloud.prototype.canCollide=function(){return!1};RAPT.CorrosionCloud.prototype.avoidsSpawn=function(){return!0};
RAPT.CorrosionCloud.prototype.move=function(a){if(!this.target)return new RAPT.Vector(0,0);var b=this.target.getCenter().sub(this.getCenter());this.heading=RAPT.adjustAngleToTarget(this.heading,b.atan2(),7);b=RAPT.CORROSION_CLOUD_SPEED*RAPT.CORROSION_CLOUD_ACCEL*a;this.velocity.x+=b*Math.cos(this.heading);this.velocity.y+=b*Math.sin(this.heading);this.velocity.lengthSquared()>RAPT.CORROSION_CLOUD_SPEED*RAPT.CORROSION_CLOUD_SPEED&&(this.velocity.normalize(),this.velocity.inplaceMul(RAPT.CORROSION_CLOUD_SPEED));
return this.velocity.mul(a)};
RAPT.CorrosionCloud.prototype.afterTick=function(a){a=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI));a=this.getCenter().add(a.mul(RAPT.randInRange(0,RAPT.CORROSION_CLOUD_RADIUS)));var b=this.target===RAPT.gameState.playerA?0.4:0,c=this.target===RAPT.gameState.playerB?0.3:0;this.smoothedVelocity=this.smoothedVelocity.mul(0.95).add(this.velocity.mul(0.05));RAPT.Particle().position(a).velocity(this.smoothedVelocity.sub(new RAPT.Vector(0.1,0.1)),this.smoothedVelocity.add(new RAPT.Vector(0.1,0.1))).radius(0.01,
0.1).bounces(0,4).elasticity(0.05,0.9).decay(0.01,0.5).expand(1,1.2).color(0.2+b,0.2,0.2+c,1).mixColor(0.1+b,0.1,0.1+c,1).circle().gravity(-0.4,0)};RAPT.CorrosionCloud.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};RAPT.CorrosionCloud.prototype.draw=function(a){};RAPT.DOOM_MAGNET_RADIUS=0.3;RAPT.DOOM_MAGNET_ELASTICITY=0.5;RAPT.DOOM_MAGNET_RANGE=10;RAPT.DOOM_MAGNET_ACCEL=2;RAPT.MAGNET_MAX_ROTATION=2*Math.PI;RAPT.DoomMagnet=function(a){RAPT.RotatingEnemy.call(this,RAPT.ENEMY_MAGNET,a,RAPT.DOOM_MAGNET_RADIUS,0,RAPT.DOOM_MAGNET_ELASTICITY);this.sprite=new RAPT.SpriteGroup({name:"doommagnet",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[0,2]],color:16763904,list:["p1"],sizes:[[0.8,0.8]]});this.sprite.moveto(a)};RAPT.DoomMagnet.prototype=Object.create(RAPT.RotatingEnemy.prototype);
RAPT.DoomMagnet.prototype.avoidsSpawn=function(){return!0};RAPT.DoomMagnet.prototype.calcHeadingVector=function(a){if(a.isDead())return new RAPT.Vector(0,0);a=a.getCenter().sub(this.getCenter());if(a.lengthSquared()>RAPT.DOOM_MAGNET_RANGE*RAPT.DOOM_MAGNET_RANGE)return new RAPT.Vector(0,0);a.normalize();return a};
RAPT.DoomMagnet.prototype.move=function(a){var b=RAPT.gameState.playerA,c=RAPT.gameState.playerB,d=this.calcHeadingVector(b),e=this.calcHeadingVector(c),d=d.add(e).mul(RAPT.DOOM_MAGNET_ACCEL),e=this.accelerate(d,a);this.velocity.inplaceMul(Math.pow(0.547821,a));var f=this.getCenter(),g=this.sprite.group.rotation.z,h=g;!b.isDead()&&c.isDead()?h=b.getCenter().sub(f).atan2()+Math.PI:b.isDead()&&!c.isDead()?h=c.getCenter().sub(f).atan2():b.isDead()||c.isDead()||(b=0>b.getCenter().sub(f).flip().dot(c.getCenter().sub(f)),
h=d.atan2()-0.5*Math.PI+Math.PI*b);this.sprite.group.rotation.z=RAPT.adjustAngleToTarget(g,h,RAPT.MAGNET_MAX_ROTATION*a);return e};RAPT.DoomMagnet.prototype.afterTick=function(a){this.sprite.moveto(this.getCenter())};RAPT.DoomMagnet.prototype.draw=function(a){};RAPT.DOORBELL_OPEN=0;RAPT.DOORBELL_CLOSE=1;RAPT.DOORBELL_TOGGLE=2;RAPT.DOORBELL_WIDTH=0.4;RAPT.DOORBELL_HEIGHT=0.76;RAPT.DOORBELL_RADIUS=0.11;RAPT.DOORBELL_SLICES=3;
RAPT.Doorbell=function(a,b,c){RAPT.Enemy.call(this,RAPT.ENEMY_DOORBELL,1);this.hitBox=RAPT.makeAABB(a,RAPT.DOORBELL_WIDTH,RAPT.DOORBELL_HEIGHT);this.rotationPercent=1;this.restingAngle=RAPT.randInRange(0,2*Math.PI);this.behavior=b;this.visible=c;this.triggeredThisTick=this.triggeredLastTick=!1;this.doors=[];this.sprite=new RAPT.SpriteGroup({name:"doorbell",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[13,0]],color:4508774,list:["p1"]});this.sprite.moveto(a)};RAPT.Doorbell.prototype=Object.create(RAPT.Enemy.prototype);
RAPT.Doorbell.prototype.getShape=function(){return this.hitBox};RAPT.Doorbell.prototype.addDoor=function(a){this.doors.push(a)};RAPT.Doorbell.prototype.canCollide=function(){return!1};RAPT.Doorbell.prototype.tick=function(a){this.rotationPercent+=a;1<this.rotationPercent&&(this.rotationPercent=1);this.sprite.sprite[0].rotation.z=RAPT.PI90*this.rotationPercent-0.5*RAPT.PI90;this.triggeredThisTick=!1;RAPT.Enemy.prototype.tick.call(this,a);this.triggeredLastTick=this.triggeredThisTick};
RAPT.Doorbell.prototype.reactToPlayer=function(a){this.triggeredThisTick=!0;if(!this.triggeredLastTick){for(a=0;a<this.doors.length;++a)RAPT.gameState.getDoor(this.doors[a]).act(this.behavior,!1,!0);for(a=0;50>a;++a){var b=RAPT.randInRange(0,2*Math.PI),c=(new RAPT.Vector).fromAngle(b).mul(RAPT.randInRange(3,5));RAPT.Particle().position(this.getCenter()).velocity(c).angle(b).radius(0.1).bounces(3).elasticity(0.5).decay(0.01).line().color(1,1,1,1).fixangle()}this.rotationPercent=0}};RAPT.GOLDEN_COG_RADIUS=0.25;RAPT.GoldenCog=function(a){RAPT.Enemy.call(this,-1,0);this.sprite=new RAPT.SpriteGroup({name:"goldencog",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[15,0]],color:16763904,list:["p1"]});this.sprite.move(a.x,a.y);this.hitCircle=new RAPT.Circle(a,RAPT.GOLDEN_COG_RADIUS);this.timeSinceStart=0;RAPT.gameState.incrementStat(RAPT.STAT_NUM_COGS)};RAPT.GoldenCog.prototype=Object.create(RAPT.Enemy.prototype);RAPT.GoldenCog.prototype.getShape=function(){return this.hitCircle};
RAPT.GoldenCog.prototype.reactToPlayer=function(a){this.setDead(!0)};
RAPT.GoldenCog.prototype.onDeath=function(){RAPT.gameState.gameStatus===RAPT.GAME_IN_PLAY&&RAPT.gameState.incrementStat(RAPT.STAT_COGS_COLLECTED);this.sprite.remove();for(var a=this.getCenter(),b=0;100>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=this.velocity.add(c.mul(RAPT.randInRange(1,5)));RAPT.Particle().position(a).velocity(c).radius(0.01,0.05).bounces(0,4).elasticity(0.05,0.9).decay(0.01,0.5).color(0.9,0.87,0,1).mixColor(1,0.96,0,1).triangle().fixangle()}};
RAPT.GoldenCog.prototype.afterTick=function(a){this.sprite.group.rotation.z+=a};RAPT.GRENADE_LIFETIME=5;RAPT.GRENADE_RADIUS=0.2;RAPT.GRENADE_ELASTICITY=0.5;RAPT.Grenade=function(a,b,c){RAPT.FreefallEnemy.call(this,RAPT.ENEMY_GRENADE,a,RAPT.GRENADE_RADIUS,RAPT.GRENADE_ELASTICITY);this.velocity=new RAPT.Vector(c*Math.cos(b),c*Math.sin(b));this.timeUntilExplodes=RAPT.GRENADE_LIFETIME;this.sprite=new RAPT.SpriteGroup({name:"grenade",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[7,0],[8,0]],list:["p1","p2"],sizes:[[0.8,0.8]]});this.isDEAD=!1;this.sprite.moveto(a)};
RAPT.Grenade.prototype=Object.create(RAPT.FreefallEnemy.prototype);RAPT.Grenade.prototype.tick=function(a){this.timeUntilExplodes-=a;0>=this.timeUntilExplodes&&this.setDead(!0);RAPT.FreefallEnemy.prototype.tick.call(this,a)};RAPT.Grenade.prototype.afterTick=function(){if(!this.isDEAD){var a=this.getCenter(),b=1*(1-this.timeUntilExplodes/RAPT.GRENADE_LIFETIME);this.sprite.sprite[1].scale.set(b,b,b);this.sprite.moveto(a)}};RAPT.Grenade.prototype.reactToWorld=function(a){};
RAPT.Grenade.prototype.onDeath=function(){this.sprite.remove();this.isDEAD=!0;for(var a=this.getCenter(),b=0;100>b;b++){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)).mul(RAPT.randInRange(1,10));RAPT.Particle().position(a).velocity(c).radius(0.1,0.2).bounces(0,4).elasticity(0.05,0.9).decay(1E-4,0.001).expand(1,1.2).color(1,0.25,0,1).mixColor(1,0.5,0,1).triangle()}for(b=0;50>b;b++)c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=(new RAPT.Vector(0,1)).add(c.mul(RAPT.randInRange(0.25,
1))),RAPT.Particle().position(a).velocity(c).radius(0.1,0.2).bounces(1,3).elasticity(0.05,0.9).decay(5E-4,0.1).expand(1.1,1.3).color(0,0,0,1).mixColor(0.5,0.5,0.5,1).circle().gravity(-0.4,0)};RAPT.GRENADIER_WIDTH=0.5;RAPT.GRENADIER_HEIGHT=0.5;RAPT.GRENADIER_RANGE=8;RAPT.GRENADIER_SHOOT_FREQ=1.2;
RAPT.Grenadier=function(a,b){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_GRENADIER,a,RAPT.GRENADIER_WIDTH,RAPT.GRENADIER_HEIGHT,0,RAPT.GRENADIER_SHOOT_FREQ,RAPT.randInRange(0,RAPT.GRENADIER_SHOOT_FREQ));this.target=b;this.targetRecoilDistance=this.actualRecoilDistance=0;this.sprite=new RAPT.SpriteGroup({name:"grenadier",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[8+this.target.color,0]],list:["p1"],pos:[[0,0,-0.01]]});this.sprite.moveto(a)};RAPT.Grenadier.prototype=Object.create(RAPT.SpawningEnemy.prototype);
RAPT.Grenadier.prototype.getTarget=function(){return this.target===RAPT.gameState.GetPlayerB()};RAPT.Grenadier.prototype.setTarget=function(a){this.target=a};RAPT.Grenadier.prototype.canCollide=function(){return!1};
RAPT.Grenadier.prototype.spawn=function(){var a=this.target.getCenter().add(new RAPT.Vector(0,3)).sub(this.getCenter()),b=a.atan2(),c=a.length();return!this.target.isDead()&&c<RAPT.GRENADIER_RANGE&&!RAPT.gameState.collider.lineOfSightWorld(this.getCenter(),this.target.getCenter(),RAPT.gameState.world)?(this.targetRecoilDistance=0.6/RAPT.GRENADIER_RANGE*c,RAPT.gameState.addEnemy(new RAPT.Grenade(this.getCenter(),b,a.length()),this.getCenter()),!0):!1};
RAPT.Grenadier.prototype.afterTick=function(a){var b=this.getCenter();this.target.isDead()||(this.sprite.group.rotation.z=this.target.getCenter().add(new RAPT.Vector(0,3)).sub(b).atan2()+Math.PI/2);this.actualRecoilDistance<this.targetRecoilDistance?(this.actualRecoilDistance+=5*a,this.actualRecoilDistance>=this.targetRecoilDistance&&(this.actualRecoilDistance=this.targetRecoilDistance,this.targetRecoilDistance=0)):(this.actualRecoilDistance-=0.5*a,0>=this.actualRecoilDistance&&(this.actualRecoilDistance=
0))};RAPT.HEADACHE_RADIUS=0.15;RAPT.HEADACHE_ELASTICITY=0;RAPT.HEADACHE_SPEED=3;RAPT.HEADACHE_RANGE=6;RAPT.HEADACHE_CLOUD_RADIUS=0.5*RAPT.HEADACHE_RADIUS;RAPT.Headache=function(a,b){RAPT.HoveringEnemy.call(this,RAPT.ENEMY_HEADACHE,a,RAPT.HEADACHE_RADIUS,RAPT.HEADACHE_ELASTICITY);this.target=b;this.isTracking=this.isAttached=!1;this.sprite=new RAPT.SpriteGroup({name:"headache",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[4+this.target.color,2]],list:["p1"],pos:[[0,0,0.02]]});this.sprite.moveto(a)};
RAPT.Headache.prototype=Object.create(RAPT.HoveringEnemy.prototype);
RAPT.Headache.prototype.move=function(a){this.isTracking=!1;if(this.isAttached)this.target.isDead()&&this.setDead(!0),b=this.target.getCenter().add(new RAPT.Vector(0,0.45)).sub(this.getCenter()),this.target.getCrouch()&&this.target.isOnFloor()&&(b.y-=0.25,b.x=this.target.facingRight?b.x+0.15:b.x-0.15),this.hitCircle.moveBy(b);else{if(this.target.isDead())return new RAPT.Vector(0,0);var b=this.target.getCenter().sub(this.getCenter());if(b.lengthSquared()<RAPT.HEADACHE_RANGE*RAPT.HEADACHE_RANGE&&!RAPT.gameState.collider.lineOfSightWorld(this.getCenter(),
this.target.getCenter(),RAPT.gameState.world))return b.y+=0.45,b.lengthSquared()>RAPT.HEADACHE_SPEED*a*RAPT.HEADACHE_SPEED*a*3?(this.isTracking=!0,b.normalize(),b=b.mul(RAPT.HEADACHE_SPEED*a)):this.isAttached=!0,b}return new RAPT.Vector(0,0)};RAPT.Headache.prototype.reactToWorld=function(){};
RAPT.Headache.prototype.onDeath=function(){this.sprite.remove();RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS);var a=this.getCenter(),b=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)).mul(RAPT.randInRange(0,0.05)),b=RAPT.Particle().position(a).velocity(b).radius(RAPT.HEADACHE_RADIUS).bounces(3).elasticity(0.5).decay(0.01).circle().gravity(5);this.target==RAPT.gameState.playerA?b.color(1,0,0,1):b.color(0,0,1,1);for(a=0;50>a;++a){var c=RAPT.randInRange(0,2*Math.PI),b=(new RAPT.Vector).fromAngle(c).mul(RAPT.randInRange(3,
5));RAPT.Particle().position(this.getCenter()).velocity(b).angle(c).radius(0.05).bounces(3).elasticity(0.5).decay(0.01).line().color(0,0,0,1)}};RAPT.Headache.prototype.reactToPlayer=function(a){a===this.target?a.disableJump():0>a.getVelocity().y&&a.getCenter().y>this.getCenter().y&&this.setDead(!0)};RAPT.Headache.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};
RAPT.Headache.prototype.afterTick=function(a){var b=this.getCenter();this.sprite.moveto(b);this.sprite.group.rotation.z+=3*a};RAPT.HELP_SIGN_WIDTH=0.76;RAPT.HELP_SIGN_HEIGHT=0.76;RAPT.HelpSign=function(a,b,c){RAPT.Enemy.call(this,RAPT.ENEMY_HELP_SIGN,0);this.sprite=new RAPT.SpriteGroup({name:"helpsign",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[14,0]],color:16763904,list:["p1"]});this.sprite.moveto(a);this.hitBox=RAPT.makeAABB(a,RAPT.HELP_SIGN_WIDTH,RAPT.HELP_SIGN_HEIGHT);this.text=b;this.drawText=!1;this.timeSinceStart=0;this.isWasSeen=!1};RAPT.HelpSign.prototype=Object.create(RAPT.Enemy.prototype);
RAPT.HelpSign.prototype.getShape=function(){return this.hitBox};RAPT.HelpSign.prototype.canCollide=function(){return!1};RAPT.HelpSign.prototype.tick=function(a){var b=this.timeSinceStart-Math.floor(this.timeSinceStart),b=Math.cos(2*b*Math.PI)/16+1;this.sprite.group.scale.x=b;this.sprite.group.scale.y=b;this.timeSinceStart+=a;this.drawText=!1;RAPT.Enemy.prototype.tick.call(this,a);this.drawText&&RAPT.gameState.message(this.text)};RAPT.HelpSign.prototype.reactToPlayer=function(a){this.drawText=!0};RAPT.HUNTER_RADIUS=0.3;RAPT.HUNTER_ELASTICITY=0.4;RAPT.HUNTER_CHASE_ACCEL=14;RAPT.HUNTER_FLEE_ACCEL=3;RAPT.HUNTER_FLEE_RANGE=10;RAPT.HUNTER_CHASE_RANGE=8;RAPT.HUNTER_LOOKAHEAD=20;RAPT.STATE_IDLE=0;RAPT.STATE_RED=1;RAPT.STATE_BLUE=2;RAPT.STATE_BOTH=3;
RAPT.Hunter=function(a){RAPT.RotatingEnemy.call(this,RAPT.ENEMY_HUNTER,a,RAPT.HUNTER_RADIUS,0,RAPT.HUNTER_ELASTICITY);this.angle=0;this.state=RAPT.STATE_IDLE;this.acceleration=new RAPT.Vector(0,0);this.jawAngle=0;this.sprite=new RAPT.SpriteGroup({name:"hunter",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[1,2],[3,2],[2,2]],color:16763904,parent:["","body","body"],list:["body","bottom","top"],pos:[[0,0,0],[-0.25,0,0],[-0.25,0,0]],center:[[0,0],[0.25,0],[0.25,0]],sizes:[[0.9,0.9]]});this.sprite.moveto(a)};
RAPT.Hunter.prototype=Object.create(RAPT.RotatingEnemy.prototype);RAPT.Hunter.prototype.avoidsSpawn=function(){return!0};RAPT.Hunter.prototype.calcAcceleration=function(a){return a.unit().sub(this.velocity.mul(3/RAPT.HUNTER_CHASE_ACCEL)).unit().mul(RAPT.HUNTER_CHASE_ACCEL)};RAPT.Hunter.prototype.playerInSight=function(a,b){if(a.isDead())return!1;var c=b<RAPT.HUNTER_CHASE_RANGE*RAPT.HUNTER_CHASE_RANGE;return c&=!RAPT.gameState.collider.lineOfSightWorld(this.getCenter(),a.getCenter(),RAPT.gameState.world)};
RAPT.Hunter.prototype.move=function(a){var b=RAPT.gameState.playerA.getCenter().sub(this.getCenter()),c=RAPT.gameState.playerB.getCenter().sub(this.getCenter()),d=b.add(RAPT.gameState.playerA.getVelocity().mul(RAPT.HUNTER_LOOKAHEAD*a)),e=c.add(RAPT.gameState.playerB.getVelocity().mul(RAPT.HUNTER_LOOKAHEAD*a)),f=b.lengthSquared(),g=c.lengthSquared(),h=this.playerInSight(RAPT.gameState.playerA,f),k=this.playerInSight(RAPT.gameState.playerB,g);h?k?0<=b.dot(this.velocity)*c.dot(this.velocity)?(this.acceleration=
b.unit().add(c.unit()).mul(-0.5*RAPT.HUNTER_FLEE_ACCEL),this.target=null,this.state=RAPT.STATE_BOTH):f<g?(this.acceleration=this.calcAcceleration(d),this.target=RAPT.gameState.playerA,this.state=RAPT.STATE_RED):(this.acceleration=this.calcAcceleration(e),this.target=RAPT.gameState.playerB,this.state=RAPT.STATE_BLUE):(this.acceleration=this.calcAcceleration(d),this.target=RAPT.gameState.playerA,this.state=RAPT.STATE_RED):k?(this.acceleration=this.calcAcceleration(e),this.target=RAPT.gameState.playerB,
this.state=RAPT.STATE_BLUE):(this.acceleration.x=this.acceleration.y=0,this.target=null,this.state=RAPT.STATE_IDLE);this.velocity.inplaceMul(Math.pow(0.366032,a));return this.accelerate(this.acceleration,a)};
RAPT.Hunter.prototype.afterTick=function(a){var b=this.getCenter();this.sprite.moveto(b);if(this.target){var c=this.angle,b=this.target.getCenter().sub(b).atan2();this.angle=RAPT.adjustAngleToTarget(c,b,Math.PI*a);this.sprite.group.rotation.z=this.angle}this.jawAngle=RAPT.adjustAngleToTarget(this.jawAngle,this.target?-0.2:0,0.4*a);this.sprite.sprite[1].rotation.z=this.jawAngle;this.sprite.sprite[2].rotation.z=-this.jawAngle};RAPT.Hunter.prototype.draw=function(a){};RAPT.JET_STREAM_WIDTH=0.4;RAPT.JET_STREAM_HEIGHT=0.4;RAPT.JET_STREAM_SHOOT_FREQ=0.2;RAPT.NUM_BARRELS=3;RAPT.JetStream=function(a,b){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_JET_STREAM,a,RAPT.JET_STREAM_WIDTH,RAPT.JET_STREAM_HEIGHT,0,RAPT.JET_STREAM_SHOOT_FREQ,0);this.direction=b;this.reloadAnimation=0;this.sprite=new RAPT.SpriteGroup({name:"jetstream",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[1,5],[0,5]],color:16763904,list:["p1","p2"],sizes:[[0.8,0.8]],pos:[[-0.2,-0.2],[0.2,0.2]]});this.sprite.moveto(a)};
RAPT.JetStream.prototype=Object.create(RAPT.SpawningEnemy.prototype);RAPT.JetStream.prototype.canCollide=function(){return!1};RAPT.JetStream.prototype.spawn=function(){RAPT.gameState.addEnemy(new RAPT.RiotBullet(this.getCenter(),this.direction),this.getCenter());return!0};
RAPT.JetStream.prototype.afterTick=function(a){this.reloadAnimation+=0.5/RAPT.JET_STREAM_SHOOT_FREQ*a;a=RAPT.TwoPI/RAPT.NUM_BARRELS*this.reloadAnimation;var b=this.direction-RAPT.PI90;(new RAPT.Vector).fromAngle(b).mul(0.2);this.getCenter();this.sprite.sprite[0].rotation.z=b+a;this.sprite.sprite[1].rotation.z=b-a};RAPT.JetStream.prototype.draw=function(a){};RAPT.LASER_RADIUS=0.15;RAPT.LASER_SPEED=5;RAPT.LASER_BOUNCES=0;RAPT.Laser=function(a,b){RAPT.FreefallEnemy.call(this,RAPT.ENEMY_LASER,a,RAPT.LASER_RADIUS,1);this.bouncesLeft=RAPT.LASER_BOUNCES;this.velocity=new RAPT.Vector(RAPT.LASER_SPEED*Math.cos(b),RAPT.LASER_SPEED*Math.sin(b));this.sprite=new RAPT.SpriteGroup({name:"laser",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[4,2]],list:["p1"]});this.sprite.moveto(a);this.sprite.sprite[0].rotation.z=b};RAPT.Laser.prototype=Object.create(RAPT.FreefallEnemy.prototype);
RAPT.Laser.prototype.move=function(a){this.sprite.moveto(this.getCenter());return this.velocity.mul(a)};RAPT.Laser.prototype.reactToWorld=function(a){if(0>=this.bouncesLeft){this.setDead(!0);a=this.getCenter();for(var b=0;20>b;++b){var c=RAPT.randInRange(0,2*Math.PI),d=(new RAPT.Vector).fromAngle(c),d=d.mul(RAPT.randInRange(0.5,5));RAPT.Particle().position(a).velocity(d).angle(c).radius(0.1).bounces(1).elasticity(1).decay(0.01).gravity(0).color(1,1,1,1).line()}}else--this.bouncesLeft};
RAPT.Laser.prototype.onDeath=function(){this.sprite.remove()};RAPT.MULTI_GUN_WIDTH=0.5;RAPT.MULTI_GUN_HEIGHT=0.5;RAPT.MULTI_GUN_SHOOT_FREQ=1.25;RAPT.MULTI_GUN_RANGE=8;
RAPT.MultiGun=function(a){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_MULTI_GUN,a,RAPT.MULTI_GUN_WIDTH,RAPT.MULTI_GUN_HEIGHT,0,RAPT.MULTI_GUN_SHOOT_FREQ,0);this.blueGun=this.redGun=null;this.gunFired=Array(4);this.gunPositions=Array(4);var b=this.getCenter();this.redGun=new RAPT.Vector(b.x,b.y);this.blueGun=new RAPT.Vector(b.x,b.y);this.gunPositions[0]=this.hitBox.lowerLeft;this.gunPositions[1]=new RAPT.Vector(this.hitBox.getRight(),this.hitBox.getBottom());this.gunPositions[2]=new RAPT.Vector(this.hitBox.getLeft(),
this.hitBox.getTop());this.gunPositions[3]=this.hitBox.lowerLeft.add(new RAPT.Vector(this.hitBox.getWidth(),this.hitBox.getHeight()));this.sprite=new RAPT.SpriteGroup({name:"spikenall",material:RAPT.MAT_ENEMY,size:1,nuv:16,list:["p1","p2","p3","p4"],uvs:[[3,3],[4,3],[5,3],[6,3]]});this.sprite.moveto(a)};RAPT.MultiGun.prototype=Object.create(RAPT.SpawningEnemy.prototype);RAPT.MultiGun.prototype.canCollide=function(){return!1};
RAPT.MultiGun.prototype.vectorToIndex=function(a){return(0>a.x?0:1)+(0>a.y?0:2)};
RAPT.MultiGun.prototype.spawn=function(){for(var a=0;4>a;++a)this.gunFired[a]=!1;for(var b=!1,a=0;2>a;++a){var c=RAPT.gameState.getPlayer(a),d=this.vectorToIndex(c.getCenter().sub(this.getCenter())),e=c.getCenter().sub(this.gunPositions[d]);!c.isDead()&&e.lengthSquared()<RAPT.MULTI_GUN_RANGE*RAPT.MULTI_GUN_RANGE&&!RAPT.gameState.collider.lineOfSightWorld(this.gunPositions[d],c.getCenter(),RAPT.gameState.world)&&!this.gunFired[d]&&(RAPT.gameState.addEnemy(new RAPT.Laser(this.gunPositions[d],e.atan2()),
this.gunPositions[d]),b=this.gunFired[d]=!0)}return b};
RAPT.MultiGun.prototype.afterTick=function(a){var b=this.getCenter(),c=this.gunPositions[this.vectorToIndex(RAPT.gameState.playerA.getCenter().sub(b))],d=this.gunPositions[this.vectorToIndex(RAPT.gameState.playerB.getCenter().sub(b))];a*=4;this.redGun.adjustTowardsTarget(c,a);this.blueGun.adjustTowardsTarget(d,a);c=this.redGun.sub(b).atan2()-RAPT.PI90;this.sprite.sprite[1].rotation.z=c;this.sprite.sprite[2].rotation.z=c;this.sprite.sprite[1].position.set(this.redGun.x-b.x,this.redGun.y-b.y,0);this.sprite.sprite[2].position.set(this.blueGun.x-
b.x,this.blueGun.y-b.y,0)};RAPT.POPPER_NUM_SPRITES=9;RAPT.popperStandingKeyframe=(new RAPT.Keyframe(0,0.1)).add(0,-80,-80,80,80,100,100,-100,-100);RAPT.popperJumpingKeyframes=[(new RAPT.Keyframe(0,0.2)).add(0,-40,-30,30,40,40,40,-40,-40),(new RAPT.Keyframe(0,0.1)).add(0,-80,-80,80,80,100,100,-100,-100)];RAPT.POPPER_RADIUS=0.4;RAPT.POPPER_JUMP_DELAY=0.5;RAPT.POPPER_MIN_JUMP_Y=2.5;RAPT.POPPER_MAX_JUMP_Y=6.5;RAPT.POPPER_ELASTICITY=0.5;RAPT.POPPER_ACCEL=-6;
RAPT.Popper=function(a){RAPT.WalkingEnemy.call(this,RAPT.ENEMY_POPPER,a,RAPT.POPPER_RADIUS,RAPT.POPPER_ELASTICITY);this.sprite=new RAPT.SpriteGroup({name:"popper",material:RAPT.MAT_ENEMY,size:1,uvs:[[0,3],[1,3],[1,3],[1,3],[1,3],[2,3],[2,3],[2,3],[2,3]],nuv:16,color:4508774,list:"body p1 p2 p3 p4 l1 l2 l3 l4".split(" "),parent:" body body body body p1 p2 p3 p4".split(" "),pos:[[0,0,0],[-0.25,-0.25,-1],[-0.1,-0.25,-1],[0.1,-0.25,-1],[0.25,-0.25,-1],[0,-0.25,-2],[0,-0.25,-2],[0,-0.25,-2],[0,-0.25,-2]],
center:[[0,0],[0,-0.125],[0,-0.125],[0,-0.125],[0,-0.125],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25]]});this.sprite.moveto(a);this.onFloor=!1;this.timeToNextJump=RAPT.POPPER_JUMP_DELAY};RAPT.Popper.prototype=Object.create(RAPT.WalkingEnemy.prototype);
RAPT.Popper.prototype.move=function(a){0>=this.timeToNextJump?(this.velocity.y=RAPT.randInRange(RAPT.POPPER_MIN_JUMP_Y,RAPT.POPPER_MAX_JUMP_Y),this.velocity.x=0.5<Math.random()?RAPT.POPPER_MAX_JUMP_Y-this.velocity.y:-RAPT.POPPER_MAX_JUMP_Y+this.velocity.y,this.timeToNextJump=RAPT.POPPER_JUMP_DELAY,this.onFloor=!1):this.onFloor&&(this.timeToNextJump-=a);return this.accelerate(new RAPT.Vector(0,RAPT.POPPER_ACCEL),a)};
RAPT.Popper.prototype.reactToWorld=function(a){0.999<=a.normal.y&&(this.velocity.x=0,this.velocity.y=0,this.onFloor=!0)};
RAPT.Popper.prototype.afterTick=function(a){a=this.getCenter();var b={},c={};RAPT.gameState.collider.closestToEntityWorld(this,2*RAPT.POPPER_RADIUS,b,c,RAPT.gameState.world)<3*RAPT.POPPER_RADIUS&&b.ref.eq(a.add(new RAPT.Vector(0,-RAPT.POPPER_RADIUS)))&&0.1>c.ref.sub(b.ref).length()?b=RAPT.popperStandingKeyframe:(b=-0.25*this.velocity.y,b=RAPT.popperJumpingKeyframes[0].lerpWith(RAPT.popperJumpingKeyframes[1],0>b?1/(1-b)-1:1-1/(1+b)));this.sprite.moveto(a.add(b.center));for(a=0;a<RAPT.POPPER_NUM_SPRITES;a++)this.sprite.sprite[a].rotation.z=
b.angles[a]};RAPT.Popper.prototype.draw=function(a){};RAPT.Popper.prototype.avoidsSpawn=function(){return!0};RAPT.RIOT_BULLET_RADIUS=0.1;RAPT.RIOT_BULLET_SPEED=7;RAPT.RiotBullet=function(a,b){RAPT.FreefallEnemy.call(this,RAPT.ENEMY_RIOT_BULLET,a,RAPT.RIOT_BULLET_RADIUS,0);this.velocity=new RAPT.Vector(RAPT.RIOT_BULLET_SPEED*Math.cos(b),RAPT.RIOT_BULLET_SPEED*Math.sin(b));this.sprite=new RAPT.SpriteGroup({name:"riotbullet",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[2,5]],color:16763904,list:["p1"],sizes:[[0.7,0.7]]});this.sprite.moveto(a)};RAPT.RiotBullet.prototype=Object.create(RAPT.FreefallEnemy.prototype);
RAPT.RiotBullet.prototype.reactToPlayer=function(a){if(!this.isDead()){var b=this.velocity.mul(0.75);a.addToVelocity(b)}this.setDead(!0)};RAPT.RiotBullet.prototype.afterTick=function(a){this.sprite.moveto(this.getCenter())};
RAPT.RiotBullet.prototype.onDeath=function(){var a=this.getCenter();this.sprite.remove();for(var b=0;5>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=this.velocity.add(c.mul(RAPT.randInRange(0.1,1)));RAPT.Particle().position(a).velocity(c).radius(0.01,0.1).bounces(0,4).elasticity(0.05,0.9).decay(5E-4,0.005).expand(1,1.2).color(0.9,0.9,0,1).mixColor(1,1,0,1).circle()}RAPT.Enemy.prototype.onDeath.call(this)};RAPT.RiotBullet.prototype.draw=function(a){};RAPT.SPIDER_NUM_SPRITES=17;RAPT.spiderWalkingKeyframes=[(new RAPT.Keyframe).add(0,-10,-20,-10,10,-10,10,-10,-20,20,10,70,20,70,20,20,10),(new RAPT.Keyframe).add(0,10,-10,-20,-10,-20,-10,10,-10,20,20,10,70,10,70,20,20),(new RAPT.Keyframe).add(0,-10,10,-10,-20,-10,-20,-10,10,70,20,20,10,20,10,70,20),(new RAPT.Keyframe).add(0,-20,-10,10,-10,10,-10,-20,-10,10,70,20,20,20,20,10,70)];
RAPT.spiderFallingKeyframes=[(new RAPT.Keyframe).add(0,7,3,-1,-5,5,1,-3,-7,-14,-6,2,10,-10,-2,6,14),(new RAPT.Keyframe).add(0,30,10,-30,-20,30,40,-10,-35,-50,-90,40,20,-50,-40,70,30)];RAPT.SPIDER_WIDTH=0.9;RAPT.SPIDER_HEIGHT=0.3;RAPT.SPIDER_SHOOT_FREQ=2;RAPT.SPIDER_SPEED=1;RAPT.SPIDER_ELASTICITY=1;RAPT.SPIDER_FLOOR_DIST=1;RAPT.SPIDER_SIGHT_HEIGHT=10;
RAPT.RocketSpider=function(a,b){RAPT.SpawningEnemy.call(this,RAPT.ENEMY_ROCKET_SPIDER,a.add(new RAPT.Vector(0,0.81-RAPT.SPIDER_LEGS_RADIUS+0.5*RAPT.SPIDER_HEIGHT)),RAPT.SPIDER_WIDTH,RAPT.SPIDER_HEIGHT,RAPT.SPIDER_ELASTICITY,RAPT.SPIDER_SHOOT_FREQ,0);this.leftChasesA=!0;this.leftSpawnPoint=new RAPT.Vector(0,0);this.rightSpawnPoint=new RAPT.Vector(0,0);this.timeSinceStart=0;this.legs=new RAPT.RocketSpiderLegs(a,b,this);RAPT.gameState.addEnemy(this.legs,this.legs.getShape().getCenter());this.sprite=
new RAPT.SpriteGroup({name:"roketspider",material:RAPT.MAT_ENEMY,size:1,uvs:[[0,4],[1,4],[1,4],[1,4],[1,4],[1,4],[1,4],[1,4],[1,4],[2,4],[2,4],[2,4],[2,4],[2,4],[2,4],[2,4],[2,4]],nuv:16,color:4508774,list:"body p1 p2 p3 p4 p5 p6 p7 p8 l1 l2 l3 l4 l5 l6 l7 l8".split(" "),parent:" body body body body body body body body p1 p2 p3 p4 p5 p6 p7 p8".split(" "),pos:[[0,0,0],[0.35,0,-1],[0.15,0,-1],[-0.05,0,-1],[-0.25,0,-1],[0.25,0,-1],[0.05,0,-1],[-0.15,0,-1],[-0.35,0,-1],[0,-0.5,-2],[0,-0.5,-2],[0,-0.5,
-2],[0,-0.5,-2],[0,-0.5,-2],[0,-0.5,-2],[0,-0.5,-2],[0,-0.5,-2]],center:[[0,0],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25],[0,-0.25]]});this.sprite.moveto(a);this.animationIsOnFloor=this.animationDelay=0};RAPT.RocketSpider.prototype=Object.create(RAPT.SpawningEnemy.prototype);RAPT.RocketSpider.prototype.canCollide=function(){return!1};
RAPT.RocketSpider.prototype.playerInSight=function(a){if(a.isDead())return!1;var b=a.getCenter().sub(this.getCenter()),c=b.atan2();return b.y<RAPT.SPIDER_SIGHT_HEIGHT&&c>0.25*Math.PI&&c<0.75*Math.PI?!RAPT.gameState.collider.lineOfSightWorld(this.getCenter(),a.getCenter(),RAPT.gameState.world):!1};RAPT.RocketSpider.prototype.spawnRocket=function(a,b,c){RAPT.gameState.addEnemy(new RAPT.Rocket(a,b,c),this.getCenter())};
RAPT.RocketSpider.prototype.spawn=function(){var a=this.getCenter();this.leftSpawnPoint=new RAPT.Vector(a.x-0.4*RAPT.SPIDER_WIDTH,a.y+0.4*RAPT.SPIDER_HEIGHT);this.rightSpawnPoint=new RAPT.Vector(a.x+0.4*RAPT.SPIDER_WIDTH,a.y+0.4*RAPT.SPIDER_HEIGHT);return this.playerInSight(RAPT.gameState.playerA)?(this.playerInSight(RAPT.gameState.playerB)?(this.spawnRocket(this.leftChasesA?this.leftSpawnPoint:this.rightSpawnPoint,RAPT.gameState.playerA,this.leftChasesA?0.75*Math.PI:0.25*Math.PI),this.spawnRocket(this.leftChasesA?
this.rightSpawnPoint:this.leftSpawnPoint,RAPT.gameState.playerB,this.leftChasesA?0.25*Math.PI:0.75*Math.PI),this.leftChasesA=!this.leftChasesA):(this.spawnRocket(this.leftSpawnPoint,RAPT.gameState.playerA,0.75*Math.PI),this.spawnRocket(this.rightSpawnPoint,RAPT.gameState.playerA,0.25*Math.PI)),!0):this.playerInSight(RAPT.gameState.playerB)?(this.spawnRocket(this.leftSpawnPoint,RAPT.gameState.playerB,0.75*Math.PI),this.spawnRocket(this.rightSpawnPoint,RAPT.gameState.playerB,0.25*Math.PI),!0):!1};
RAPT.RocketSpider.prototype.move=function(a){return this.legs.getCenter().sub(this.getCenter()).add(new RAPT.Vector(0,0.81-RAPT.SPIDER_LEGS_RADIUS+0.5*RAPT.SPIDER_HEIGHT))};
RAPT.RocketSpider.prototype.afterTick=function(a){var b=this.getCenter();this.sprite.moveto(b);this.sprite.flip(0>this.legs.velocity.x);b=this.legs.isOnFloor();b!=this.animationIsOnFloor?1<++this.animationDelay&&(this.animationIsOnFloor=b,this.animationDelay=0):this.animationDelay=0;this.timeSinceStart+=0.5*a;this.animationIsOnFloor?a=(new RAPT.Keyframe).lerp(RAPT.spiderWalkingKeyframes,10*this.timeSinceStart):(a=-0.25*this.legs.velocity.y,a=RAPT.spiderFallingKeyframes[0].lerpWith(RAPT.spiderFallingKeyframes[1],
0.01>a?0:1-1/(1+a)));for(b=0;b<RAPT.SPIDER_NUM_SPRITES;b++)this.sprite.sprite[b].rotation.z=a.angles[b]};RAPT.RocketSpider.prototype.reactToPlayer=function(a){a.setDead(!0)};RAPT.RocketSpider.prototype.onDeath=function(){RAPT.Particle().position(this.getCenter()).bounces(1).gravity(5).decay(0.1).customSprite(this.sprite).color(0,0,0,1).angle(0).angularVelocity(RAPT.randInRange(-Math.PI,Math.PI));this.sprite.remove()};RAPT.SPIDER_LEGS_RADIUS=0.45;RAPT.SPIDER_LEGS_WEAK_SPOT_RADIUS=0.2;RAPT.SPIDER_LEGS_ELASTICITY=1;RAPT.SPIDER_LEGS_FLOOR_ELASTICITY=0.1;RAPT.RocketSpiderLegs=function(a,b,c){RAPT.WalkingEnemy.call(this,-1,a,RAPT.SPIDER_LEGS_RADIUS,RAPT.SPIDER_LEGS_ELASTICITY);this.body=c;this.weakSpot=new RAPT.Circle(a,RAPT.SPIDER_LEGS_WEAK_SPOT_RADIUS);this.velocity=b<=0.5*Math.PI||b>0.6666666*Math.PI?new RAPT.Vector(RAPT.SPIDER_SPEED,0):new RAPT.Vector(-RAPT.SPIDER_SPEED,0)};RAPT.RocketSpiderLegs.prototype=Object.create(RAPT.WalkingEnemy.prototype);
RAPT.RocketSpiderLegs.prototype.playerWillCollide=function(a){if(a.isDead())return!1;var b=0.01>Math.abs(a.getShape().getAabb().getBottom()-this.hitCircle.getAabb().getBottom());a=a.getCenter().x-this.getCenter().x;return b=b&&1>Math.abs(a)&&-0.01<this.velocity.x*a};
RAPT.RocketSpiderLegs.prototype.move=function(a){if(this.isOnFloor()){if(this.playerWillCollide(RAPT.gameState.playerA)||this.playerWillCollide(RAPT.gameState.playerB))this.velocity.x*=-1;return this.velocity.mul(a)}return this.accelerate(new RAPT.Vector(0,RAPT.FREEFALL_ACCEL),a)};RAPT.RocketSpiderLegs.prototype.reactToWorld=function(a){RAPT.getOrientation(a.normal)===RAPT.EDGE_FLOOR&&(a=this.velocity.projectOntoAUnitVector(a.normal),this.velocity=this.velocity.sub(a).unit().mul(RAPT.SPIDER_SPEED).add(a.mul(RAPT.SPIDER_LEGS_FLOOR_ELASTICITY)))};
RAPT.RocketSpiderLegs.prototype.reactToPlayer=function(a){this.weakSpot.moveTo(this.hitCircle.getCenter());0===RAPT.gameState.collider.overlapShapePlayers(this.weakSpot).length&&this.setDead(!0)};RAPT.RocketSpiderLegs.prototype.setDead=function(a){this.body.setDead(a);RAPT.Enemy.prototype.setDead.call(this,a)};
RAPT.RocketSpiderLegs.prototype.onDeath=function(){RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS);for(var a=this.getCenter(),b=0;16>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=c.mul(RAPT.randInRange(0.5,5)),d=RAPT.randInRange(0,2*Math.PI),e=RAPT.randInRange(-Math.PI,Math.PI);RAPT.Particle().position(a).velocity(c).radius(0.25).bounces(3).elasticity(0.5).decay(0.01).line().angle(d).angularVelocity(e).color(0,0,0,1)}};RAPT.RocketSpiderLegs.prototype.draw=function(a){};RAPT.SHOCK_HAWK_RADIUS=0.3;RAPT.SHOCK_HAWK_ACCEL=6;RAPT.SHOCK_HAWK_DECEL=0.8;RAPT.SHOCK_HAWK_RANGE=10;RAPT.ShockHawk=function(a,b){RAPT.HoveringEnemy.call(this,RAPT.ENEMY_SHOCK_HAWK,a,RAPT.SHOCK_HAWK_RADIUS,0);this.target=b;this.chasing=!1;this.sprite=new RAPT.SpriteGroup({name:"shockhawk",material:RAPT.MAT_ENEMY,size:1,nuv:16,uvs:[[this.target.color+2,0]],list:["p1"]});this.sprite.moveto(a)};RAPT.ShockHawk.prototype=Object.create(RAPT.HoveringEnemy.prototype);
RAPT.ShockHawk.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};RAPT.ShockHawk.prototype.setTarget=function(a){this.target=a};RAPT.ShockHawk.prototype.avoidsSpawn=function(){return this.chasing?!1:!0};
RAPT.ShockHawk.prototype.move=function(a){this.velocity.inplaceMul(Math.pow(0.8185668046884278,a));if(!this.target||this.target.isDead())return this.chasing=!1,this.accelerate(this.velocity.mul(-RAPT.SHOCK_HAWK_DECEL),a);var b=this.target.getCenter().sub(this.getCenter());if(b.lengthSquared()>RAPT.SHOCK_HAWK_RANGE*RAPT.SHOCK_HAWK_RANGE)return this.chasing=!1,this.accelerate(this.velocity.mul(-RAPT.SHOCK_HAWK_DECEL),a);this.chasing=!0;b.normalize();b=b.mul(RAPT.SHOCK_HAWK_ACCEL);return this.accelerate(b,
a)};RAPT.ShockHawk.prototype.onDeath=function(){RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS)};RAPT.ShockHawk.prototype.afterTick=function(a){a=this.getCenter();this.sprite.moveto(a);this.target.isDead()||(this.sprite.group.rotation.z=this.target.getCenter().sub(a).atan2())};RAPT.ShockHawk.prototype.draw=function(a){};RAPT.SPIKE_BALL_RADIUS=0.2;
RAPT.SpikeBall=function(a){RAPT.Enemy.call(this,RAPT.ENEMY_SPIKE_BALL,0);this.sprite=new RAPT.SpriteGroup({name:"spikenall",material:RAPT.MAT_ENEMY,size:1,nuv:16,color:16763904,list:["p1","p2","p3"],sizes:[[0.5,0.5]]});this.sprite.moveto(a);this.hitCircle=new RAPT.Circle(a,RAPT.SPIKE_BALL_RADIUS);this.sprite.sprite[0].rotation.z=RAPT.randInRange(0,RAPT.TwoPI);this.sprite.sprite[1].rotation.z=RAPT.randInRange(0,RAPT.TwoPI);this.sprite.sprite[2].rotation.z=RAPT.randInRange(0,RAPT.TwoPI)};
RAPT.SpikeBall.prototype=Object.create(RAPT.Enemy.prototype);RAPT.SpikeBall.prototype.getShape=function(){return this.hitCircle};RAPT.SpikeBall.prototype.canCollide=function(){return!1};RAPT.SpikeBall.prototype.afterTick=function(a){this.sprite.sprite[0].rotation.z-=25*a*RAPT.ToRad;this.sprite.sprite[1].rotation.z+=65*a*RAPT.ToRad;this.sprite.sprite[2].rotation.z+=15*a*RAPT.ToRad};RAPT.STALACBAT_RADIUS=0.2;RAPT.STALACBAT_SPEED=2;RAPT.Stalacbat=function(a,b){RAPT.FreefallEnemy.call(this,RAPT.ENEMY_STALACBAT,a,RAPT.STALACBAT_RADIUS,0);this.target=b;this.isFalling=!1;this.sprite=new RAPT.SpriteGroup({name:"stalacbat",material:RAPT.MAT_ENEMY,color:4508672,nuv:16,list:["p1","w0","w1"],uvs:[[this.target.color+1,1],[4,1],[5,1]]});this.sprite.moveto(a);this.startPosY=a.y;this.exp=!1};RAPT.Stalacbat.prototype=Object.create(RAPT.FreefallEnemy.prototype);
RAPT.Stalacbat.prototype.move=function(a){if(this.isFalling)return RAPT.FreefallEnemy.prototype.move.call(this,a);if(null!==this.target&&!this.target.isDead()){var b=this.target.getCenter(),c=this.getCenter();if(0.1>Math.abs(b.x-c.x)&&b.y<c.y&&!RAPT.gameState.collider.lineOfSightWorld(c,b,RAPT.gameState.world))return this.isFalling=!0,RAPT.FreefallEnemy.prototype.move.call(this,a)}return new RAPT.Vector(0,0)};RAPT.Stalacbat.prototype.getTarget=function(){return this.target===RAPT.gameState.playerB};
RAPT.Stalacbat.prototype.afterTick=function(a){a=-0.25*this.velocity.y;1<a&&(a=1);if(!this.exp){var b=this.getCenter();this.sprite.sprite[0].position.y=b.y-0.2*a-this.startPosY;a*=RAPT.PI90;this.sprite.sprite[1].rotation.z=a;this.sprite.sprite[2].rotation.z=-a}};
RAPT.Stalacbat.prototype.onDeath=function(){RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS);this.exp=!0;this.sprite.remove();for(var a=this.target===RAPT.gameState.playerA?0.8:0,b=this.target===RAPT.gameState.playerB?1:0,c=this.getCenter(),d=0;15>d;++d){var e=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)).mul(RAPT.randInRange(5,10));RAPT.Particle().position(c).velocity(e).radius(0.2).bounces(3).decay(0.01).elasticity(0.5).color(a,0,b,1).triangle().fixangle()}};
RAPT.Stalacbat.prototype.draw=function(a){};RAPT.WALL_AVOIDER_RADIUS=0.3;RAPT.WALL_AVOIDER_ACCEL=3.3;RAPT.WallAvoider=function(a,b){RAPT.RotatingEnemy.call(this,RAPT.ENEMY_WALL_AVOIDER,a,RAPT.WALL_AVOIDER_RADIUS,0,0);this.target=b;this.acceleration=new RAPT.Vector(0,0);this.angularVelocity=0;this.sprite=new RAPT.SpriteGroup({name:"wallavoider",material:RAPT.MAT_ENEMY,nuv:16,list:["p1"],uvs:[[this.target.color+2,5]]});this.sprite.moveto(a)};RAPT.WallAvoider.prototype=new RAPT.RotatingEnemy;RAPT.WallAvoider.prototype=Object.create(RAPT.RotatingEnemy.prototype);
RAPT.WallAvoider.prototype.move=function(a){if(this.target.isDead())return this.velocity.x=this.velocity.y=0,this.velocity.mul(a);var b=this.target.getCenter().sub(this.getCenter()),c={},d=RAPT.gameState.collider.closestToEntityWorld(this,5,{},c,RAPT.gameState.world);if(0.001>d)return this.accelerate(new RAPT.Vector(0,0),a);this.acceleration=b.unit();d<Number.POSITIVE_INFINITY&&(b=c.ref.sub(this.getCenter()).mul(-1/(d*d)),this.acceleration.inplaceAdd(b));this.acceleration.normalize();this.acceleration.inplaceMul(RAPT.WALL_AVOIDER_ACCEL);
this.velocity.inplaceMul(Math.pow(0.366032,a));return this.accelerate(this.acceleration,a)};RAPT.WallAvoider.prototype.reactToWorld=function(a){this.setDead(!0)};
RAPT.WallAvoider.prototype.onDeath=function(){this.sprite.remove();RAPT.gameState.incrementStat(RAPT.STAT_ENEMY_DEATHS);for(var a=this.getCenter(),b=0;50>b;++b){var c=(new RAPT.Vector).fromAngle(RAPT.randInRange(0,2*Math.PI)),c=c.mul(RAPT.randInRange(0.5,17));RAPT.Particle().position(a).velocity(c).radius(0.02,0.15).bounces(0,4).elasticity(0.05,0.9).decay(1E-6,1E-5).expand(1,1.2).color(1,0.3,0,1).mixColor(1,0.1,0,1).triangle()}};
RAPT.WallAvoider.prototype.getTarget=function(){return this.target===RAPT.gameState.getPlayerB()};RAPT.WallAvoider.prototype.afterTick=function(a){this.sprite.moveto(this.getCenter());this.angularVelocity=0.5*(this.angularVelocity+RAPT.randInRange(-Math.PI,Math.PI));this.sprite.group.rotation.z+=this.angularVelocity*a};RAPT.WALL_CRAWLER_SPEED=1;RAPT.WALL_CRAWLER_RADIUS=0.25;RAPT.PULL_FACTOR=0.9;RAPT.PUSH_FACTOR=0.11;RAPT.WallCrawler=function(a,b){RAPT.WalkingEnemy.call(this,RAPT.ENEMY_CRAWLER,a,RAPT.WALL_CRAWLER_RADIUS,0);this.sprite=new RAPT.SpriteGroup({name:"wallcrawler",material:RAPT.MAT_ENEMY,size:1,uvs:[[1,1]],nuv:16,color:4508774,list:["p1"],sizes:[[0.7,0.7]]});this.firstTick=!0;this.clockwise=!1;this.velocity=new RAPT.Vector(Math.cos(b),Math.sin(b))};RAPT.WallCrawler.prototype=Object.create(RAPT.WalkingEnemy.prototype);
RAPT.WallCrawler.prototype.move=function(a){var b={};if(RAPT.gameState.collider.closestToEntityWorld(this,2,{},b,RAPT.gameState.world)<Number.POSITIVE_INFINITY){var b=this.getCenter().sub(b.ref),c=b.flip();this.firstTick&&(0>this.velocity.dot(c)?this.clockwise=!0:this.clockwise=!1,this.firstTick=!1);b.lengthSquared()>RAPT.WALL_CRAWLER_RADIUS*RAPT.WALL_CRAWLER_RADIUS*1.1?this.velocity=this.clockwise?c.mul(-1).sub(b.mul(RAPT.PULL_FACTOR)):c.sub(b.mul(RAPT.PULL_FACTOR)):this.velocity=this.clockwise?
c.mul(-1).add(b.mul(RAPT.PUSH_FACTOR)):c.add(b.mul(RAPT.PUSH_FACTOR));this.velocity.normalize()}return this.velocity.mul(RAPT.WALL_CRAWLER_SPEED*a)};RAPT.WallCrawler.prototype.afterTick=function(a){a*=RAPT.WALL_CRAWLER_SPEED/RAPT.WALL_CRAWLER_RADIUS;this.sprite.moveto(this.getCenter());this.sprite.group.rotation.z=this.clockwise?this.sprite.group.rotation.z+a:this.sprite.group.rotation.z-a};RAPT.WallCrawler.prototype.draw=function(a){};RAPT.WHEELIGATOR_RADIUS=0.3;RAPT.WHEELIGATOR_SPEED=3;RAPT.WHEELIGATOR_ELASTICITY=1;RAPT.WHEELIGATOR_FLOOR_ELASTICITY=0.3;RAPT.Wheeligator=function(a,b){RAPT.WalkingEnemy.call(this,RAPT.ENEMY_WHEELIGATOR,a,RAPT.WHEELIGATOR_RADIUS,RAPT.WHEELIGATOR_ELASTICITY);this.sprite=new RAPT.SpriteGroup({name:"wheeligator",material:RAPT.MAT_ENEMY,size:0.7,uvs:[[0,1]],nuv:16,color:4508774,list:["p1"]});this.hitGround=!1;this.angularVelocity=0;this.startsRight=0<Math.cos(b)};RAPT.Wheeligator.prototype=Object.create(RAPT.WalkingEnemy.prototype);
RAPT.Wheeligator.prototype.move=function(a){var b=this.isOnFloor();!this.hitGround&&b&&this.velocity.x<RAPT.WHEELIGATOR_SPEED&&(this.velocity.x=this.startsRight?RAPT.WHEELIGATOR_SPEED:-RAPT.WHEELIGATOR_SPEED,this.hitGround=!0);b&&(this.angularVelocity=-this.velocity.x/RAPT.WHEELIGATOR_RADIUS);this.velocity.y+=RAPT.FREEFALL_ACCEL*a;return this.velocity.mul(a)};
RAPT.Wheeligator.prototype.reactToWorld=function(a){RAPT.getOrientation(a.normal)===RAPT.EDGE_FLOOR&&(a=this.velocity.projectOntoAUnitVector(a.normal),this.velocity=this.velocity.sub(a).add(a.mul(RAPT.WHEELIGATOR_FLOOR_ELASTICITY)),this.angularVelocity=-this.velocity.x/RAPT.WHEELIGATOR_RADIUS)};RAPT.Wheeligator.prototype.afterTick=function(a){this.sprite.moveto(this.getCenter());this.sprite.group.rotation.z+=this.angularVelocity*a};RAPT.Wheeligator.prototype.draw=function(a){};
